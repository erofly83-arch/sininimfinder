<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Smart Matcher V2.2 ‚Äî –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  min-height: 100vh;
}

.container { max-width: 1600px; margin: 0 auto; }

.header {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

h1 { 
  font-size: 26px; 
  font-weight: 700; 
  color: #1c1c1e; 
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.version-badge {
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}

.subtitle { 
  color: #8e8e93; 
  font-size: 13px; 
  line-height: 1.5;
}

.export-top {
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  border: none;
  padding: 14px 32px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: none;
  margin-top: 16px;
}

.export-top.show { display: inline-block; }
.export-top:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(52, 199, 89, 0.4); }
.export-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }

.upload-panel {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.upload-box {
  border: 2px dashed #e5e5ea;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.upload-box:hover { border-color: #667eea; background: #f9f9fb; }
.upload-box.loaded { border-color: #34c759; background: #f0fdf4; }

.upload-icon { font-size: 48px; margin-bottom: 12px; }
.upload-title { font-size: 16px; font-weight: 600; color: #1c1c1e; margin-bottom: 8px; }
.upload-desc { font-size: 13px; color: #8e8e93; margin-bottom: 16px; line-height: 1.4; }

.format-badges {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-bottom: 16px;
}

.format-badge {
  background: #e8f0ff;
  color: #667eea;
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
}

.upload-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.upload-btn:hover { background: #5568d3; transform: translateY(-2px); }
.upload-status { margin-top: 12px; font-size: 13px; color: #34c759; font-weight: 500; }

input[type="file"] { display: none; }

.stats-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.stats-bar.show { display: block; }

.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

.stat-item {
  text-align: center;
  padding: 16px;
  border-radius: 12px;
  transition: all 0.2s;
  cursor: pointer;
  border: 2px solid transparent;
}

.stat-item:hover {
  background: #f9f9fb;
  border-color: #667eea;
  transform: translateY(-2px);
}

.stat-item.active {
  background: #e8f0ff;
  border-color: #667eea;
}

.stat-value { font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 4px; }
.stat-label { font-size: 12px; color: #8e8e93; text-transform: uppercase; font-weight: 600; }

.results-panel {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.results-panel.show { display: block; }

.results-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f2f2f7;
}

.results-title { font-size: 20px; font-weight: 600; color: #1c1c1e; }
.results-subtitle { font-size: 13px; color: #8e8e93; margin-top: 4px; }

.results-list { max-height: 650px; overflow-y: auto; }

.result-card {
  border: 2px solid #e5e5ea;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  transition: all 0.2s;
  cursor: pointer;
}

.result-card:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  transform: translateY(-1px);
}

.result-card.high-match { border-color: #34c759; background: #f0fdf4; }
.result-card.medium-match { border-color: #ff9500; background: #fff9e6; }
.result-card.skipped-card { border-color: #8e8e93; background: #f9f9fb; }

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.card-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.similarity-badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  color: white;
}

.similarity-high { background: #34c759; }
.similarity-medium { background: #ff9500; }
.similarity-skip { background: #8e8e93; }

.match-tags {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.match-tag {
  background: #e8f0ff;
  color: #667eea;
  padding: 3px 7px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
}

.action-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.action-synonym { background: #ff9500; color: white; }
.action-main { background: #5856d6; color: white; }
.action-skip { background: #8e8e93; color: white; }

.comparison-vertical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.name-box {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  border-left: 4px solid #667eea;
}

.name-box.price-box { border-left-color: #ff9500; }
.name-box.json-box { border-left-color: #34c759; }

.name-label {
  font-size: 11px;
  font-weight: 600;
  color: #8e8e93;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-text {
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
  line-height: 1.4;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.barcode-info {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: #667eea;
  margin-top: 6px;
  font-weight: 600;
}

.highlight {
  background: #d4f4dd;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 700;
  color: #1c7d3a;
}

.score-details {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e5ea;
  font-size: 11px;
  color: #8e8e93;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.score-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #f9f9fb;
  padding: 3px 8px;
  border-radius: 6px;
}

.score-icon { font-size: 12px; }

.empty-state { text-align: center; padding: 60px 20px; color: #8e8e93; }
.empty-icon { font-size: 64px; margin-bottom: 16px; }

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show { display: flex; }

.modal-content {
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 20px 20px 16px 20px;
  border-bottom: 2px solid #f2f2f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title { font-size: 18px; font-weight: 600; color: #1c1c1e; }

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #8e8e93;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.2s;
}

.modal-close:hover { background: #f2f2f7; }
.modal-body { padding: 20px; }

.similarity-info-compact {
  text-align: center;
  padding: 12px;
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  border-radius: 10px;
  margin-bottom: 16px;
}

.similarity-percent-compact { font-size: 28px; font-weight: 700; color: white; }
.similarity-text-compact { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 2px; }

.action-info-compact {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #856404;
}

.action-info-compact.main {
  background: #e8e5ff;
  border-left-color: #5856d6;
  color: #3a38a0;
}

.product-compact {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
}

.product-header-compact {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.product-badge { 
  font-size: 11px;
  font-weight: 600;
  color: #667eea;
  background: #e8f0ff;
  padding: 4px 10px;
  border-radius: 12px;
}

.product-barcode-compact {
  font-family: 'Courier New', monospace;
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
}

.product-name-compact { 
  font-size: 16px; 
  color: #1c1c1e; 
  line-height: 1.4; 
  margin-top: 6px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.modal-actions {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  padding: 16px 20px;
  border-top: 2px solid #f2f2f7;
}

.modal-btn {
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.cancel { background: #f2f2f7; color: #8e8e93; }
.modal-btn.cancel:hover { background: #e5e5ea; }
.modal-btn.confirm { background: #34c759; color: white; }
.modal-btn.confirm:hover { background: #28a745; transform: translateY(-2px); }

.progress-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.progress-bar.show { display: block; }

.progress-text {
  font-size: 14px;
  color: #1c1c1e;
  margin-bottom: 12px;
  font-weight: 600;
  text-align: center;
}

.progress-track { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
  width: 0%;
}

@media (max-width: 768px) {
  .upload-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .modal-actions { grid-template-columns: 1fr; }
}
:root { --global-nav-h: 52px; }

.global-nav{
  position: sticky;
  top: 0;
  z-index: 5000;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(0,0,0,0.08);
}

.global-nav__inner{
  max-width: 1600px;
  margin: 0 auto;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.global-nav__brand{
  text-decoration: none;
  font-weight: 800;
  color: #1c1c1e;
  white-space: nowrap;
}

.global-nav__links{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.global-nav__link{
  text-decoration: none;
  font-size: 13px;
  font-weight: 650;
  color: #007aff;
  background: rgba(0,122,255,0.08);
  border: 1px solid rgba(0,122,255,0.18);
  padding: 6px 10px;
  border-radius: 999px;
  white-space: nowrap;
  transition: transform .12s ease, background .12s ease;
}

.global-nav__link:hover{
  transform: translateY(-1px);
  background: rgba(0,122,255,0.14);
}

.global-nav__link.is-active{
  color: #fff;
  background: #007aff;
  border-color: #007aff;
}

  </style>
</head>
<body>
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">
      –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
    </a>

    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">
        –†–µ–¥–∞–∫—Ç–æ—Ä JSON
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">
        –û–±—Ä–µ–∑–∞—Ç–µ–ª—å
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">
        –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      </a>
    </nav>
  </div>
</header>
  <div class="container">
    <div class="header">
      <h1>
        üéØ Smart Matcher 
        <span class="version-badge">V2.2</span>
      </h1>
      <div class="subtitle">
        –£–º–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON, CSV, XLSX
      </div>

      <button class="export-top" id="exportTopBtn" onclick="exportJSON()">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π JSON <span class="export-count" id="exportTopCount">0</span>
      </button>
    </div>

    <div class="upload-panel">
      <div class="upload-grid">
        <div class="upload-box" id="jsonBox" onclick="document.getElementById('jsonInput').click()">
          <div class="upload-icon">üì¶</div>
          <div class="upload-title">–ë–∞–∑–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
          <div class="upload-desc">
            JSON, CSV –∏–ª–∏ XLSX —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:<br>
            <strong>–®—Ç—Ä–∏—Ö–∫–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –°–∏–Ω–æ–Ω–∏–º—ã</strong>
          </div>
          <div class="format-badges">
            <span class="format-badge">JSON</span>
            <span class="format-badge">CSV</span>
            <span class="format-badge">XLSX</span>
          </div>
          <button class="upload-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
          <div class="upload-status" id="jsonStatus"></div>
          <input type="file" id="jsonInput" accept=".json,.csv,.xlsx,.xls">
        </div>

        <div class="upload-box" id="priceBox" onclick="document.getElementById('priceInput').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-title">–ü—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
          <div class="upload-desc">
            CSV –∏–ª–∏ XLSX —Å —Ç–æ–≤–∞—Ä–∞–º–∏
          </div>
          <div class="format-badges">
            <span class="format-badge">CSV</span>
            <span class="format-badge">XLSX</span>
          </div>
          <button class="upload-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
          <div class="upload-status" id="priceStatus"></div>
          <input type="file" id="priceInput" accept=".csv,.xlsx,.xls">
        </div>
      </div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="stats-bar" id="statsBar">
      <div class="stats-grid">
        <div class="stat-item" onclick="filterByView('all')" data-view="all">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –≤ –ø—Ä–∞–π—Å–µ</div>
        </div>
        <div class="stat-item" onclick="filterByView('new')" data-view="new">
          <div class="stat-value" id="statNew">0</div>
          <div class="stat-label">–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
        </div>
        <div class="stat-item" onclick="filterByView('high')" data-view="high">
          <div class="stat-value" id="statHigh">0</div>
          <div class="stat-label">–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-item" onclick="filterByView('skipped')" data-view="skipped">
          <div class="stat-value" id="statSkipped">0</div>
          <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
        </div>
      </div>
    </div>

    <div class="results-panel" id="resultsPanel">
      <div class="results-header">
        <div class="results-title" id="resultsTitle">üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã</div>
        <div class="results-subtitle" id="resultsSubtitle"></div>
      </div>

      <div class="results-list" id="resultsList">
        <div class="empty-state">
          <div class="empty-icon">üîç</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
          <div>–ë–∞–∑–∞ (JSON/CSV/XLSX) + –ø—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîó –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="similarity-info-compact">
          <div class="similarity-percent-compact" id="modalSimilarity">0%</div>
          <div class="similarity-text-compact">–û–±—â–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å</div>
        </div>

        <div class="action-info-compact" id="actionInfoCompact">
          <span id="actionTextCompact"></span>
        </div>

        <div class="product-compact">
          <div class="product-header-compact">
            <span class="product-badge">üìÑ –ù–û–í–´–ô</span>
            <div class="product-barcode-compact" id="modalPriceBarcode"></div>
          </div>
          <div class="product-name-compact" id="modalPriceName"></div>
        </div>

        <div style="text-align:center;color:#34c759;font-size:24px;margin:12px 0;">‚¨á</div>

        <div class="product-compact">
          <div class="product-header-compact">
            <span class="product-badge">üì¶ –ë–ê–ó–ê</span>
            <div class="product-barcode-compact" id="modalMainBarcode"></div>
          </div>
          <div class="product-name-compact" id="modalMainName"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()"></button>
      </div>
    </div>
  </div>

  <script>

    let jsonData = {};
    let priceData = [];
    let allMatches = [];
    let matchResults = [];
    let skippedItems = [];
    let highMatches = [];
    let changesMap = new Map();
    let pendingAction = null;
    let currentView = 'new';

    const BARCODE_COLS = ['—à—Ç—Ä–∏—Ö–∫–æ–¥', '—à—Ç—Ä–∏—Ö-–∫–æ–¥', 'barcode', '–®–ö', '—à–∫', '–∫–æ–¥', 'ean', '–®—Ç—Ä–∏—Ö–∫–æ–¥'];
    const NAME_COLS = ['–Ω–∞–∑–≤–∞–Ω–∏–µ', 'name', '—Ç–æ–≤–∞—Ä', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ø—Ä–æ–¥—É–∫—Ç', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'];
    const SYNONYM_COLS = ['—Å–∏–Ω–æ–Ω–∏–º—ã', 'synonyms', '—Å–∏–Ω–æ–Ω–∏–º', 'synonym', '–°–∏–Ω–æ–Ω–∏–º—ã'];
    const SIMILARITY_THRESHOLD = 60;

    // –í—Å–µ —Å–ª–æ–≤–∞—Ä–∏ –±—Ä–µ–Ω–¥–æ–≤, –≤–∫—É—Å–æ–≤ –∏ —Ç.–¥. (—Å–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω—ã–º–∏)
    const BRAND_SYNONYMS = {
      'nescafe': ['–Ω–µ—Å–∫–∞—Ñ–µ', 'nescafe', 'neskafe', '–Ω–µ—Å–∫–∞—Ñ—ç'],
      'jacobs': ['—è–∫–æ–±—Å', 'jacobs', 'jacobz', 'jakobs'],
      'orbit': ['–æ—Ä–±–∏—Ç', 'orbit', '–∞—Ä–±–∏—Ç'],
      'dirol': ['–¥–∏—Ä–æ–ª', 'dirol', '–¥–∏—Ä–æ–ª–ª'],
      'snickers': ['—Å–Ω–∏–∫–µ—Ä—Å', 'snickers', '—Å–Ω–∏–∫–µ—Ä–∑'],
      'mars': ['–º–∞—Ä—Å', 'mars'],
      'twix': ['—Ç–≤–∏–∫—Å', 'twix'],
      'milka': ['–º–∏–ª–∫–∞', 'milka'],
      'kitkat': ['–∫–∏—Ç-–∫–∞—Ç', '–∫–∏—Ç–∫–∞—Ç', 'kitkat'],
      'oreo': ['–æ—Ä–µ–æ', 'oreo'],
      // ... (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
    };

    const FLAVOR_SYNONYMS = {
      'chicken': ['–∫—É—Ä–∏—Ü–∞', '–∫—É—Ä–∏–Ω—ã–π', 'chicken'],
      'beef': ['–≥–æ–≤—è–¥–∏–Ω–∞', '–≥–æ–≤—è–∂–∏–π', 'beef'],
      'vanilla': ['–≤–∞–Ω–∏–ª—å', 'vanilla', '–≤–∞–Ω–∏–ª—å–Ω—ã–π'],
      'chocolate': ['—à–æ–∫–æ–ª–∞–¥', 'chocolate', '—à–æ–∫–æ–ª–∞–¥–Ω—ã–π'],
      'mint': ['–º—è—Ç–∞', 'mint', '–º—è—Ç–Ω—ã–π'],
      // ... (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)
    };

    const PACKAGING_TYPES = {
      '—Å—Ç–±': ['—Å—Ç/–±', '—Å/–±', '—Å—Ç–±', '—Å—Ç–µ–∫–ª–æ'],
      '–º—É': ['–º/—É', '–º–µ—Ç–∞–ª–ª', '–º–µ—Ç'],
      '–∂–±': ['–∂/–±', '–∂–±', '–∂–µ—Å—Ç—è–Ω–∞—è'],
      // ... (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)
    };

    const IGNORE_PATTERNS = [
      /\([^)]+\)/g,
      /\d+—Ö\d+/g,
      /!!!.*?!!!/g,
      /\b–∞–∫—Ü–∏—è\b/gi,
      /\bnew\b/gi
    ];

    const PRODUCT_TYPES = [
      '–∫–æ—Ñ–µ', 'coffee', '—á–∞–π', 'tea', '—à–æ–∫–æ–ª–∞–¥', 'chocolate', 
      '–∂–≤–∞—á–∫–∞', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–±–∞—Ç–æ–Ω—á–∏–∫', '–ø–µ—á–µ–Ω—å–µ'
    ];

    const SYNONYM_TO_BASE = {};
    for (const [base, synonyms] of Object.entries(BRAND_SYNONYMS)) {
      for (const syn of synonyms) {
        SYNONYM_TO_BASE[syn.toLowerCase()] = base;
      }
    }

    const FLAVOR_TO_BASE = {};
    for (const [base, synonyms] of Object.entries(FLAVOR_SYNONYMS)) {
      for (const syn of synonyms) {
        FLAVOR_TO_BASE[syn.toLowerCase()] = base;
      }
    }

    const PACKAGING_TO_BASE = {};
    for (const [base, variants] of Object.entries(PACKAGING_TYPES)) {
      for (const variant of variants) {
        PACKAGING_TO_BASE[variant.toLowerCase()] = base;
      }
    }

    // ============= –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–ê–†–°–ï–† –ë–ê–ó–´ =============
    document.getElementById('jsonInput').addEventListener('change', handleBaseUpload);
    document.getElementById('priceInput').addEventListener('change', handlePriceUpload);

    async function handleBaseUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      try {
        showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã —Å–∏–Ω–æ–Ω–∏–º–æ–≤...');

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.json')) {
          // JSON —Ñ–æ—Ä–º–∞—Ç
          const text = await file.text();
          jsonData = JSON.parse(text);
        } else if (fileName.endsWith('.csv')) {
          // CSV —Ñ–æ—Ä–º–∞—Ç
          const data = await parseCSV(file);
          jsonData = convertTableToJSON(data);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          // Excel —Ñ–æ—Ä–º–∞—Ç
          const data = await parseExcel(file);
          jsonData = convertTableToJSON(data);
        } else {
          throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }

        document.getElementById('jsonBox').classList.add('loaded');
        document.getElementById('jsonStatus').textContent = `‚úì ${Object.keys(jsonData).length} –∑–∞–ø–∏—Å–µ–π`;

        hideProgress();
        checkAndAnalyze();
      } catch (error) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã: ' + error.message);
      }
    }

    function convertTableToJSON(data) {
      const result = {};

      if (!data || data.length === 0) {
        throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
      }

      // –ò—â–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      const barcodeCol = findColumn(data, BARCODE_COLS);
      const nameCol = findColumn(data, NAME_COLS);
      const synonymCol = findColumn(data, SYNONYM_COLS);

      if (!barcodeCol || !nameCol) {
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –®—Ç—Ä–∏—Ö–∫–æ–¥ –∏ –ù–∞–∑–≤–∞–Ω–∏–µ');
      }

      for (const row of data) {
        const barcode = String(row[barcodeCol] || '').trim();
        const name = String(row[nameCol] || '').trim();
        const synonyms = synonymCol ? String(row[synonymCol] || '').trim() : '';

        if (barcode && name) {
          result[barcode] = [name, synonyms];
        }
      }

      return result;
    }

    async function handlePriceUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      try {
        showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...');

        if (file.name.toLowerCase().endsWith('.csv')) {
          priceData = await parseCSV(file);
        } else {
          priceData = await parseExcel(file);
        }

        document.getElementById('priceBox').classList.add('loaded');
        document.getElementById('priceStatus').textContent = `‚úì ${priceData.length} —Ç–æ–≤–∞—Ä–æ–≤`;

        hideProgress();
        checkAndAnalyze();
      } catch (error) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: ' + error.message);
      }
    }

    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (error) => reject(error)
        });
      });
    }

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function checkAndAnalyze() {
      if (Object.keys(jsonData).length > 0 && priceData.length > 0) {
        performEnhancedMatching();
      }
    }

    function findColumn(data, synonyms) {
      if (!data || data.length === 0) return null;
      const columns = Object.keys(data[0]);
      return columns.find(col => 
        synonyms.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
      ) || columns[0];
    }

    function cleanText(text) {
      let cleaned = String(text || '');
      for (const pattern of IGNORE_PATTERNS) {
        cleaned = cleaned.replace(pattern, ' ');
      }
      return cleaned.trim();
    }

    function normalizeText(text) {
      text = cleanText(text);
      return text
        .toLowerCase()
        .replace(/[^–∞-—èa-z0-9]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function extractWeight(text) {
      const weightMatch = text.match(/(\d+(?:[.,]\d+)?)\s*([–≥–∫–º–ª])/i);
      if (weightMatch) {
        const value = parseFloat(weightMatch[1].replace(',', '.'));
        const unit = weightMatch[2].toLowerCase();
        return { value, unit };
      }
      return null;
    }

    function compareWeights(weight1, weight2) {
      if (!weight1 || !weight2) return 0;
      if (weight1.unit !== weight2.unit) return 0;
      if (weight1.value === weight2.value) return 20;
      const diff = Math.abs(weight1.value - weight2.value);
      const percent = (diff / weight1.value) * 100;
      if (percent <= 10) return 10;
      return 0;
    }

    function extractBrand(text) {
      const normalized = normalizeText(text);
      const words = normalized.split(' ');
      for (const word of words) {
        if (SYNONYM_TO_BASE[word]) {
          return SYNONYM_TO_BASE[word];
        }
      }
      return null;
    }

    function extractProductType(text) {
      const normalized = normalizeText(text);
      for (const type of PRODUCT_TYPES) {
        if (normalized.includes(type)) {
          return type;
        }
      }
      return null;
    }

    function extractFlavor(text) {
      const normalized = normalizeText(text);
      const words = normalized.split(' ');
      for (const word of words) {
        if (FLAVOR_TO_BASE[word]) {
          return FLAVOR_TO_BASE[word];
        }
      }
      return null;
    }

    function calculateEnhancedSimilarity(text1, text2) {
      let totalScore = 0;
      const maxScore = 110;
      const details = [];
      const matchedTokens = new Set();

      const brand1 = extractBrand(text1);
      const brand2 = extractBrand(text2);
      if (brand1 && brand2 && brand1 === brand2) {
        totalScore += 30;
        details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 30, matched: true });
        matchedTokens.add(brand1);
      } else {
        details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 0, matched: false });
      }

      const type1 = extractProductType(text1);
      const type2 = extractProductType(text2);
      if (type1 && type2 && type1 === type2) {
        totalScore += 25;
        details.push({ component: 'üì¶ –¢–∏–ø —Ç–æ–≤–∞—Ä–∞', score: 25, matched: true });
        matchedTokens.add(type1);
      } else {
        details.push({ component: 'üì¶ –¢–∏–ø —Ç–æ–≤–∞—Ä–∞', score: 0, matched: false });
      }

      const weight1 = extractWeight(text1);
      const weight2 = extractWeight(text2);
      const weightScore = compareWeights(weight1, weight2);
      if (weightScore > 0) {
        totalScore += weightScore;
        details.push({ 
          component: '‚öñÔ∏è –í–µ—Å', 
          score: weightScore, 
          matched: true,
          exact: weightScore === 20
        });
        if (weight1) matchedTokens.add(weight1.value + weight1.unit);
      } else {
        details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 0, matched: false });
      }

      const flavor1 = extractFlavor(text1);
      const flavor2 = extractFlavor(text2);
      if (flavor1 && flavor2 && flavor1 === flavor2) {
        totalScore += 15;
        details.push({ component: 'üçì –í–∫—É—Å', score: 15, matched: true });
        matchedTokens.add(flavor1);
      } else {
        details.push({ component: 'üçì –í–∫—É—Å', score: 0, matched: false });
      }

      const normalized1 = normalizeText(text1).split(' ');
      const normalized2 = normalizeText(text2).split(' ');
      const cleaned1 = normalized1.filter(w => !PACKAGING_TO_BASE[w]);
      const cleaned2 = normalized2.filter(w => !PACKAGING_TO_BASE[w]);
      const set1 = new Set(cleaned1);
      const set2 = new Set(cleaned2);
      const commonWords = [...set1].filter(w => set2.has(w) && w.length > 2);

      if (commonWords.length > 0) {
        const wordScore = Math.min(10, commonWords.length * 3);
        totalScore += wordScore;
        details.push({ component: 'üìù –û–±—â–∏–µ —Å–ª–æ–≤–∞', score: wordScore, matched: true });
        commonWords.forEach(w => matchedTokens.add(w));
      } else {
        details.push({ component: 'üìù –û–±—â–∏–µ —Å–ª–æ–≤–∞', score: 0, matched: false });
      }

      const finalPercent = Math.round((totalScore / maxScore) * 100);

      const tags = [];
      if (brand1 === brand2) tags.push('üè∑Ô∏è');
      if (type1 === type2) tags.push('üì¶');
      if (weightScore === 20) tags.push('‚öñÔ∏è');
      if (weightScore === 10) tags.push('‚öñÔ∏è~');
      if (flavor1 === flavor2) tags.push('üçì');
      if (commonWords.length > 0) tags.push(`üìù${commonWords.length}`);

      return {
        score: finalPercent,
        totalScore: totalScore,
        maxScore: maxScore,
        details: details,
        tags: tags,
        matchedTokens: matchedTokens
      };
    }

    function highlightMatches(text, matchedTokens) {
      if (!matchedTokens || matchedTokens.size === 0) return text;
      let result = text;
      for (const token of matchedTokens) {
        const regex = new RegExp(`(${token})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
      }
      return result;
    }

    function isBarcode(str) {
      return /^\d{8,14}$/.test(String(str).trim());
    }

    function showProgress(text) {
      document.getElementById('progressBar').classList.add('show');
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressFill').style.width = '0%';
    }

    function updateProgress(percent) {
      document.getElementById('progressFill').style.width = percent + '%';
    }

    function hideProgress() {
      document.getElementById('progressBar').classList.remove('show');
    }

    async function performEnhancedMatching() {
      showProgress('–£–º–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥ v2.2...');
      matchResults = [];
      skippedItems = [];
      highMatches = [];
      allMatches = [];

      const barcodeCol = findColumn(priceData, BARCODE_COLS);
      const nameCol = findColumn(priceData, NAME_COLS);

      if (!barcodeCol || !nameCol) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã "–®—Ç—Ä–∏—Ö–∫–æ–¥" –∏ "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" –≤ –ø—Ä–∞–π—Å–µ');
        return;
      }

      const jsonMap = new Map();
      const allBarcodes = new Set();

      for (const [key, value] of Object.entries(jsonData)) {
        const keyIsBarcode = isBarcode(key);
        let name = key;
        let mainBarcode = keyIsBarcode ? key : '';
        let synonyms = [];

        if (Array.isArray(value)) {
          if (value.length > 0 && value[0]) {
            name = String(value[0]).trim();
          }
          if (value.length > 1 && value[1]) {
            const synonymsStr = String(value[1]).trim();
            if (synonymsStr) {
              synonyms = synonymsStr.split(';').map(s => s.trim()).filter(s => s && isBarcode(s));
            }
          }
        }

        jsonMap.set(key, {
          hasMainBarcode: keyIsBarcode,
          mainBarcode: mainBarcode,
          name: name,
          synonyms: synonyms
        });

        if (keyIsBarcode) allBarcodes.add(key);
        synonyms.forEach(syn => allBarcodes.add(syn));
      }

      for (let i = 0; i < priceData.length; i++) {
        const row = priceData[i];
        const barcode = String(row[barcodeCol] || '').trim();
        const name = String(row[nameCol] || '').trim();

        if (!barcode || !name) continue;

        let bestMatch = null;
        let bestSimilarity = 0;
        let bestResult = null;

        for (const [key, data] of jsonMap) {
          const result = calculateEnhancedSimilarity(name, data.name);
          if (result.score >= SIMILARITY_THRESHOLD && result.score > bestSimilarity) {
            bestSimilarity = result.score;
            bestMatch = { key: key, ...data };
            bestResult = result;
          }
        }

        if (bestMatch) {
          const isDuplicate = allBarcodes.has(barcode);

          if (isDuplicate) {
            skippedItems.push({
              barcode: barcode,
              name: name,
              reason: 'duplicate',
              matchName: bestMatch.name,
              mainBarcode: bestMatch.mainBarcode,
              similarity: bestSimilarity,
              matchResult: bestResult
            });
          } else {
            const matchData = {
              barcode: barcode,
              name: name,
              mainBarcode: bestMatch.mainBarcode,
              mainName: bestMatch.name,
              synonyms: bestMatch.synonyms,
              hasMainBarcode: bestMatch.hasMainBarcode,
              jsonKey: bestMatch.key,
              similarity: bestSimilarity,
              matchResult: bestResult,
              status: bestSimilarity >= 80 ? 'high' : 'medium'
            };

            matchResults.push(matchData);

            if (bestSimilarity >= 80) {
              highMatches.push(matchData);
            }
          }

          allMatches.push({
            barcode: barcode,
            name: name,
            status: isDuplicate ? 'skipped' : 'new',
            similarity: bestSimilarity,
            matchData: bestMatch,
            matchResult: bestResult
          });
        }

        updateProgress((i / priceData.length) * 100);
        await new Promise(resolve => setTimeout(resolve, 0));
      }

      matchResults.sort((a, b) => b.similarity - a.similarity);

      document.getElementById('statTotal').textContent = priceData.length;
      document.getElementById('statNew').textContent = matchResults.length;
      document.getElementById('statHigh').textContent = highMatches.length;
      document.getElementById('statSkipped').textContent = skippedItems.length;

      document.getElementById('statsBar').classList.add('show');
      document.getElementById('resultsPanel').classList.add('show');

      hideProgress();
      filterByView('new');
    }

    function filterByView(view) {
      currentView = view;

      document.querySelectorAll('.stat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) {
          item.classList.add('active');
        }
      });

      if (view === 'new') {
        document.getElementById('resultsTitle').textContent = 'üìä –ù–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã';
        document.getElementById('resultsSubtitle').textContent = `${matchResults.length} —Ç–æ–≤–∞—Ä–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é`;
        renderResults(matchResults, 'new');
      } else if (view === 'high') {
        document.getElementById('resultsTitle').textContent = '‚≠ê –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (‚â•80%)';
        document.getElementById('resultsSubtitle').textContent = `${highMatches.length} —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ö–æ–∂–µ—Å—Ç—å—é`;
        renderResults(highMatches, 'high');
      } else if (view === 'skipped') {
        document.getElementById('resultsTitle').textContent = '‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ (–¥—É–±–ª–∏)';
        document.getElementById('resultsSubtitle').textContent = `${skippedItems.length} —Ç–æ–≤–∞—Ä–æ–≤ —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ`;
        renderResults(skippedItems, 'skipped');
      } else {
        document.getElementById('resultsTitle').textContent = 'üìã –í—Å–µ —Ç–æ–≤–∞—Ä—ã';
        document.getElementById('resultsSubtitle').textContent = `${allMatches.length} —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏`;
        renderResults(allMatches, 'all');
      }
    }

    function renderResults(items, type) {
      const container = document.getElementById('resultsList');

      if (items.length === 0) {
        let emptyText = '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
        if (type === 'new') emptyText = '–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        if (type === 'skipped') emptyText = '–ù–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤';
        if (type === 'high') emptyText = '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ö–æ–∂–µ—Å—Ç—å—é';

        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úì</div>
            <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${emptyText}</div>
          </div>
        `;
        return;
      }

      let html = '';

      items.forEach((item, index) => {
        if (type === 'skipped') {
          const result = item;
          const matchTags = result.matchResult && result.matchResult.tags ? 
            result.matchResult.tags.map(m => `<span class="match-tag">${m}</span>`).join('') : '';

          const highlightedPriceName = result.matchResult ? 
            highlightMatches(result.name, result.matchResult.matchedTokens) : 
            result.name;

          const highlightedJsonName = result.matchResult ? 
            highlightMatches(result.matchName, result.matchResult.matchedTokens) : 
            result.matchName;

          let scoreDetails = '';
          if (result.matchResult && result.matchResult.details) {
            const matched = result.matchResult.details.filter(d => d.matched);
            scoreDetails = matched.map(d => 
              `<span class="score-item">
                <span class="score-icon">${d.component.split(' ')[0]}</span>
                <span>+${d.score}</span>
              </span>`
            ).join('');
          }

          html += `
            <div class="result-card skipped-card">
              <div class="card-header">
                <div class="card-left">
                  <span class="similarity-badge similarity-skip">${result.similarity}%</span>
                  <div class="match-tags">${matchTags}</div>
                </div>
                <span class="action-badge action-skip">‚è≠Ô∏è –î—É–±–ª—å</span>
              </div>

              <div class="comparison-vertical">
                <div class="name-box price-box">
                  <div class="name-label">
                    <span>üìÑ</span>
                    <span>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</span>
                  </div>
                  <div class="name-text">${highlightedPriceName}</div>
                  <div class="barcode-info">–®–ö: ${result.barcode}</div>
                </div>

                <div class="name-box json-box">
                  <div class="name-label">
                    <span>üì¶</span>
                    <span>–í –±–∞–∑–µ</span>
                  </div>
                  <div class="name-text">${highlightedJsonName}</div>
                  <div class="barcode-info">–®–ö: ${result.mainBarcode || '[–ù–µ—Ç –®–ö]'}</div>
                </div>
              </div>

              ${scoreDetails ? `<div class="score-details">${scoreDetails}</div>` : ''}
            </div>
          `;
        } else {
          const result = item;
          const simClass = result.similarity >= 80 ? 'high' : 'medium';
          const cardClass = result.similarity >= 80 ? 'high-match' : 'medium-match';
          const actionLabel = result.hasMainBarcode ? '‚ûï –°–∏–Ω–æ–Ω–∏–º' : '‚≠ê –ì–ª–∞–≤–Ω—ã–π';
          const actionClass = result.hasMainBarcode ? 'action-synonym' : 'action-main';

          const matchTags = result.matchResult && result.matchResult.tags ? 
            result.matchResult.tags.map(m => `<span class="match-tag">${m}</span>`).join('') : '';

          const highlightedPriceName = result.matchResult ? 
            highlightMatches(result.name, result.matchResult.matchedTokens) : 
            result.name;

          const highlightedJsonName = result.matchResult ? 
            highlightMatches(result.mainName, result.matchResult.matchedTokens) : 
            result.mainName;

          let scoreDetails = '';
          if (result.matchResult && result.matchResult.details) {
            const matched = result.matchResult.details.filter(d => d.matched);
            scoreDetails = matched.map(d => 
              `<span class="score-item">
                <span class="score-icon">${d.component.split(' ')[0]}</span>
                <span>+${d.score}</span>
              </span>`
            ).join('');
          }

          html += `
            <div class="result-card ${cardClass}" onclick="showConfirmModal(${index}, '${type}')">
              <div class="card-header">
                <div class="card-left">
                  <span class="similarity-badge similarity-${simClass}">${result.similarity}%</span>
                  <div class="match-tags">${matchTags}</div>
                </div>
                <span class="action-badge ${actionClass}">${actionLabel}</span>
              </div>

              <div class="comparison-vertical">
                <div class="name-box price-box">
                  <div class="name-label">
                    <span>üìÑ</span>
                    <span>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</span>
                  </div>
                  <div class="name-text">${highlightedPriceName}</div>
                  <div class="barcode-info">–®–ö: ${result.barcode}</div>
                </div>

                <div class="name-box json-box">
                  <div class="name-label">
                    <span>üì¶</span>
                    <span>–í –±–∞–∑–µ</span>
                  </div>
                  <div class="name-text">${highlightedJsonName}</div>
                  <div class="barcode-info">–®–ö: ${result.hasMainBarcode ? result.mainBarcode : '[–ù–µ—Ç –®–ö]'}</div>
                </div>
              </div>

              ${scoreDetails ? `<div class="score-details">${scoreDetails}</div>` : ''}
            </div>
          `;
        }
      });

      container.innerHTML = html;
    }

    function showConfirmModal(index, type) {
      let result;
      if (type === 'high') {
        result = highMatches[index];
      } else {
        result = matchResults[index];
      }

      pendingAction = result;

      document.getElementById('modalSimilarity').textContent = result.similarity + '%';
      document.getElementById('modalPriceBarcode').textContent = result.barcode;
      document.getElementById('modalPriceName').textContent = result.name.toUpperCase();

      const modalMainBarcode = document.getElementById('modalMainBarcode');
      if (result.hasMainBarcode) {
        modalMainBarcode.textContent = result.mainBarcode;
      } else {
        modalMainBarcode.textContent = '[–ù–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö]';
      }

      document.getElementById('modalMainName').textContent = result.mainName.toUpperCase();

      const actionInfoCompact = document.getElementById('actionInfoCompact');
      const actionTextCompact = document.getElementById('actionTextCompact');
      const confirmBtn = document.getElementById('confirmBtn');

      if (result.hasMainBarcode) {
        actionInfoCompact.className = 'action-info-compact';
        actionTextCompact.textContent = '‚ûï –®—Ç—Ä–∏—Ö–∫–æ–¥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ —Å–∏–Ω–æ–Ω–∏–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–æ–≤–∞—Ä—É';
        confirmBtn.textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º';
      } else {
        actionInfoCompact.className = 'action-info-compact main';
        actionTextCompact.textContent = '‚≠ê –®—Ç—Ä–∏—Ö–∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç –ì–õ–ê–í–ù–´–ú –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—É —Ç–æ–≤–∞—Ä–∞ —Å–µ–π—á–∞—Å –Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö)';
        confirmBtn.textContent = '‚≠ê –°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º';
      }

      document.getElementById('confirmModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('confirmModal').classList.remove('show');
      pendingAction = null;
    }

    function confirmAction() {
      if (!pendingAction) return;

      const action = pendingAction.hasMainBarcode ? 'add_synonym' : 'set_main';

      changesMap.set(pendingAction.barcode, {
        action: action,
        mainBarcode: pendingAction.mainBarcode || '',
        jsonKey: pendingAction.jsonKey || '',
        newBarcode: pendingAction.barcode,
        newName: pendingAction.name,
        mainName: pendingAction.mainName,
        similarity: pendingAction.similarity
      });

      matchResults = matchResults.filter(r => r.barcode !== pendingAction.barcode);
      highMatches = highMatches.filter(r => r.barcode !== pendingAction.barcode);

      document.getElementById('statNew').textContent = matchResults.length;
      document.getElementById('statHigh').textContent = highMatches.length;
      document.getElementById('exportTopCount').textContent = changesMap.size;
      document.getElementById('exportTopBtn').classList.add('show');

      closeModal();
      filterByView(currentView);
    }

    function exportJSON() {
      const updated = JSON.parse(JSON.stringify(jsonData));

      changesMap.forEach((change, barcode) => {
        if (change.action === 'add_synonym') {
          const mainBarcode = change.mainBarcode;
          const currentData = updated[mainBarcode];

          if (Array.isArray(currentData) && currentData.length >= 2) {
            const name = currentData[0];
            let synonymsStr = currentData[1] || '';
            let synonyms = synonymsStr ? synonymsStr.split(';').map(s => s.trim()).filter(s => s) : [];

            if (!synonyms.includes(barcode)) {
              synonyms.push(barcode);
            }

            updated[mainBarcode] = [name, synonyms.join('; ')];
          }
        } else if (change.action === 'set_main') {
          const oldKey = change.jsonKey;
          const oldName = change.mainName;

          updated[barcode] = [oldName, ''];

          if (updated[oldKey]) {
            delete updated[oldKey];
          }
        }
      });

      const json = JSON.stringify(updated, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().slice(0, 10);
      a.download = `synonyms_v2.2_${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert(`‚úÖ JSON –æ–±–Ω–æ–≤–ª—ë–Ω (V2.2)!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${changesMap.size} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n–§–∞–π–ª: synonyms_v2.2_${timestamp}.json`);
    }

    document.getElementById('confirmModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
  <script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–æ–º+–ø—É—Ç—å —Ü–µ–ª–∏–∫–æ–º
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>

</body>
</html>
