<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Smart Matcher V3.0 ‚Äî –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
}

.container { max-width: 1600px; margin: 0 auto; }

.header {
  background: white;
  border-radius: 16px;
  padding: 18px 24px;
  margin-bottom: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

h1 { 
  font-size: 26px; 
  font-weight: 700; 
  color: #1c1c1e; 
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.version-badge {
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}

.subtitle { 
  color: #8e8e93; 
  font-size: 13px; 
  line-height: 1.5;
}

.export-top {
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  border: none;
  padding: 14px 32px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: none;
  margin-top: 16px;
}

.export-top.show { display: inline-block; }
.export-top:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(52, 199, 89, 0.4); }
.export-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }

.stats-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.stats-bar.show { display: block; }

.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

.stat-item {
  text-align: center;
  padding: 16px;
  border-radius: 12px;
  transition: all 0.2s;
  cursor: pointer;
  border: 2px solid transparent;
}

.stat-item:hover {
  background: #f9f9fb;
  border-color: #667eea;
  transform: translateY(-2px);
}

.stat-item.active {
  background: #e8f0ff;
  border-color: #667eea;
}

.stat-value { font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 4px; }
.stat-label { font-size: 12px; color: #8e8e93; text-transform: uppercase; font-weight: 600; }

.results-panel {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.results-panel.show { display: block; }

.results-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f2f2f7;
}

.results-title { font-size: 20px; font-weight: 600; color: #1c1c1e; }
.results-subtitle { font-size: 13px; color: #8e8e93; margin-top: 4px; }

.results-list { max-height: 650px; overflow-y: auto; }

.result-card {
  border: 2px solid #e5e5ea;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  transition: all 0.2s;
  cursor: pointer;
}

.result-card:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  transform: translateY(-1px);
}

.result-card.high-match { border-color: #34c759; background: #f0fdf4; }
.result-card.medium-match { border-color: #ff9500; background: #fff9e6; }
.result-card.skipped-card { border-color: #8e8e93; background: #f9f9fb; }

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.card-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.similarity-badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  color: white;
}

.similarity-high { background: #34c759; }
.similarity-medium { background: #ff9500; }
.similarity-skip { background: #8e8e93; }

.match-tags {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.match-tag {
  background: #e8f0ff;
  color: #667eea;
  padding: 3px 7px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
}

.action-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.action-synonym { background: #ff9500; color: white; }
.action-main { background: #5856d6; color: white; }
.action-skip { background: #8e8e93; color: white; }

.comparison-vertical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.name-box {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  border-left: 4px solid #667eea;
}

.name-box.price-box { border-left-color: #ff9500; }
.name-box.json-box { border-left-color: #34c759; }

.name-label {
  font-size: 11px;
  font-weight: 600;
  color: #8e8e93;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-text {
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
  line-height: 1.4;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.barcode-info {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: #667eea;
  margin-top: 6px;
  font-weight: 600;
}

.highlight {
  background: #d4f4dd;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 700;
  color: #1c7d3a;
}

.score-details {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e5ea;
  font-size: 11px;
  color: #8e8e93;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.score-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #f9f9fb;
  padding: 3px 8px;
  border-radius: 6px;
}

.score-icon { font-size: 12px; }

.empty-state { text-align: center; padding: 60px 20px; color: #8e8e93; }
.empty-icon { font-size: 64px; margin-bottom: 16px; }

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show { display: flex; }

.modal-content {
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 20px 20px 16px 20px;
  border-bottom: 2px solid #f2f2f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title { font-size: 18px; font-weight: 600; color: #1c1c1e; }

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #8e8e93;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.2s;
}

.modal-close:hover { background: #f2f2f7; }
.modal-body { padding: 20px; }

.similarity-info-compact {
  text-align: center;
  padding: 12px;
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  border-radius: 10px;
  margin-bottom: 16px;
}

.similarity-percent-compact { font-size: 28px; font-weight: 700; color: white; }
.similarity-text-compact { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 2px; }

.action-info-compact {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #856404;
}

.action-info-compact.main {
  background: #e8e5ff;
  border-left-color: #5856d6;
  color: #3a38a0;
}

.product-compact {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
}

.product-header-compact {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.product-badge { 
  font-size: 11px;
  font-weight: 600;
  color: #667eea;
  background: #e8f0ff;
  padding: 4px 10px;
  border-radius: 12px;
}

.product-barcode-compact {
  font-family: 'Courier New', monospace;
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
}

.product-name-compact { 
  font-size: 16px; 
  color: #1c1c1e; 
  line-height: 1.4; 
  margin-top: 6px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.modal-actions {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  padding: 16px 20px;
  border-top: 2px solid #f2f2f7;
}

.modal-btn {
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.cancel { background: #f2f2f7; color: #8e8e93; }
.modal-btn.cancel:hover { background: #e5e5ea; }
.modal-btn.confirm { background: #34c759; color: white; }
.modal-btn.confirm:hover { background: #28a745; transform: translateY(-2px); }

.progress-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.progress-bar.show { display: block; }

.progress-text {
  font-size: 14px;
  color: #1c1c1e;
  margin-bottom: 12px;
  font-weight: 600;
  text-align: center;
}

.progress-track { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
  width: 0%;
}

/* –ù–û–í–´–ï –°–¢–ò–õ–ò V3.0 */
.candidates-section {
  margin-top: 12px;
  border-top: 1px dashed #e5e5ea;
  padding-top: 12px;
}

.candidates-title {
  font-size: 11px;
  font-weight: 700;
  color: #8e8e93;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.candidate-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  border: 1.5px solid transparent;
  transition: all 0.2s;
  background: #f2f2f7;
}

.candidate-item:hover {
  border-color: #667eea;
  background: #e8f0ff;
}

.candidate-item.selected {
  border-color: #34c759;
  background: #f0fdf4;
}

.candidate-score {
  font-size: 12px;
  font-weight: 700;
  color: white;
  padding: 2px 7px;
  border-radius: 8px;
  min-width: 40px;
  text-align: center;
  flex-shrink: 0;
}

.candidate-name {
  font-size: 13px;
  font-weight: 600;
  color: #1c1c1e;
  flex: 1;
  text-transform: uppercase;
}

.candidate-bc {
  font-size: 11px;
  color: #667eea;
  font-family: monospace;
  flex-shrink: 0;
}

.result-card.review-card { border-color: #af52de; background: #fdf4ff; }
.similarity-review { background: #af52de; }
.action-review { background: #af52de; color: white; }

.diff-indicator {
  display: inline-block;
  padding: 2px 7px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 6px;
}

.diff-weight { background: #ff3b30; color: white; }
.diff-ok { background: #34c759; color: white; }

.weight-warning {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 11px;
  color: #856404;
  font-weight: 600;
  margin-top: 6px;
}

.select-candidate-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}

.select-candidate-btn:hover { background: #5568d3; }

.trigram-score {
  font-size: 10px;
  color: #8e8e93;
  margin-left: 4px;
}


@media (max-width: 768px) {
  .upload-grid { flex-direction: column; }
  .stats-grid { grid-template-columns: repeat(2,1fr) !important; }
  .modal-actions { grid-template-columns: 1fr; }
}

/* ===== NAV ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω –≤ –¥–∏–∑–∞–π–Ω ===== */
.global-nav {
  max-width: 1600px;
  margin: 0 auto 16px auto;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.28);
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.global-nav__inner {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.global-nav__brand {
  text-decoration: none;
  font-weight: 800;
  font-size: 14px;
  color: #fff;
  white-space: nowrap;
  opacity: 0.9;
}

.global-nav__links {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

.global-nav__link {
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
  color: rgba(255,255,255,0.88);
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.28);
  padding: 5px 12px;
  border-radius: 999px;
  white-space: nowrap;
  transition: all .15s ease;
}

.global-nav__link:hover {
  background: rgba(255,255,255,0.28);
  color: #fff;
  transform: translateY(-1px);
}

.global-nav__link.is-active {
  color: #667eea;
  background: #fff;
  border-color: #fff;
}

/* ===== –ö–û–ú–ü–ê–ö–¢–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ===== */
.upload-panel {
  background: white;
  border-radius: 16px;
  padding: 12px 16px;
  margin-bottom: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.upload-grid {
  display: flex;
  gap: 10px;
  align-items: stretch;
}

.upload-box {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px dashed #e5e5ea;
  border-radius: 10px;
  padding: 12px 14px;
  transition: all 0.25s;
  cursor: pointer;
}

.upload-box:hover { border-color: #667eea; background: #f9f9fb; }
.upload-box.loaded { border-color: #34c759; background: #f0fdf4; }

.upload-icon { font-size: 24px; flex-shrink: 0; line-height: 1; }
.upload-info { flex: 1; min-width: 0; }
.upload-title { font-size: 13px; font-weight: 700; color: #1c1c1e; margin-bottom: 2px; }
.upload-desc { font-size: 11px; color: #8e8e93; line-height: 1.3; }

.upload-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; flex-shrink: 0; }

.format-badges { display: flex; gap: 4px; }
.format-badge {
  background: #e8f0ff;
  color: #667eea;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: 700;
}

.upload-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 7px;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.upload-btn:hover { background: #5568d3; }
.upload-status { font-size: 11px; color: #34c759; font-weight: 600; white-space: nowrap; text-align: right; }

input[type="file"] { display: none; }

  </style>
</head>
<body style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:16px;">
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">
      üß≠ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
    </a>

    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">
        –†–µ–¥–∞–∫—Ç–æ—Ä JSON
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">
        –û–±—Ä–µ–∑–∞—Ç–µ–ª—å
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">
        –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      </a>
    </nav>
  </div>
</header>
  <div class="container">
    <div class="header">
      <h1>
        üéØ Smart Matcher 
        <span class="version-badge">V3.0</span>
      </h1>
      <button class="export-top" id="exportTopBtn" onclick="exportJSON()">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π JSON <span class="export-count" id="exportTopCount">0</span>
      </button>
    </div>

    <div class="upload-panel">
      <div class="upload-grid">
        <div class="upload-box" id="jsonBox" onclick="document.getElementById('jsonInput').click()">
          <div class="upload-icon">üì¶</div>
          <div class="upload-info">
            <div class="upload-title">–ë–∞–∑–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
            <div class="upload-desc">JSON / CSV / XLSX ¬∑ –®—Ç—Ä–∏—Ö–∫–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –°–∏–Ω–æ–Ω–∏–º—ã</div>
            <div class="upload-status" id="jsonStatus"></div>
          </div>
          <div class="upload-right">
            <div class="format-badges">
              <span class="format-badge">JSON</span>
              <span class="format-badge">CSV</span>
              <span class="format-badge">XLSX</span>
            </div>
            <button class="upload-btn">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <input type="file" id="jsonInput" accept=".json,.csv,.xlsx,.xls">
        </div>

        <div class="upload-box" id="priceBox" onclick="document.getElementById('priceInput').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-info">
            <div class="upload-title">–ü—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
            <div class="upload-desc">CSV / XLSX ¬∑ –®—Ç—Ä–∏—Ö–∫–æ–¥ | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
            <div class="upload-status" id="priceStatus"></div>
          </div>
          <div class="upload-right">
            <div class="format-badges">
              <span class="format-badge">CSV</span>
              <span class="format-badge">XLSX</span>
            </div>
            <button class="upload-btn">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <input type="file" id="priceInput" accept=".csv,.xlsx,.xls">
        </div>
      </div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="stats-bar" id="statsBar">
      <div class="stats-grid" style="grid-template-columns: repeat(5,1fr)">
        <div class="stat-item" onclick="filterByView('all')" data-view="all">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –≤ –ø—Ä–∞–π—Å–µ</div>
        </div>
        <div class="stat-item" onclick="filterByView('high')" data-view="high">
          <div class="stat-value" id="statHigh">0</div>
          <div class="stat-label">–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-item" onclick="filterByView('new')" data-view="new">
          <div class="stat-value" id="statNew">0</div>
          <div class="stat-label">–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
        </div>
        <div class="stat-item" onclick="filterByView('review')" data-view="review">
          <div class="stat-value" id="statReview">0</div>
          <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
        </div>
        <div class="stat-item" onclick="filterByView('skipped')" data-view="skipped">
          <div class="stat-value" id="statSkipped">0</div>
          <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
        </div>
      </div>
    </div>

    <div class="results-panel" id="resultsPanel">
      <div class="results-header">
        <div class="results-title" id="resultsTitle">üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã</div>
        <div class="results-subtitle" id="resultsSubtitle"></div>
      </div>

      <div class="results-list" id="resultsList">
        <div class="empty-state">
          <div class="empty-icon">üîç</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
          <div>–ë–∞–∑–∞ (JSON/CSV/XLSX) + –ø—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîó –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="similarity-info-compact">
          <div class="similarity-percent-compact" id="modalSimilarity">0%</div>
          <div class="similarity-text-compact">–û–±—â–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å</div>
        </div>

        <div class="action-info-compact" id="actionInfoCompact">
          <span id="actionTextCompact"></span>
        </div>

        <div class="product-compact">
          <div class="product-header-compact">
            <span class="product-badge">üìÑ –ù–û–í–´–ô</span>
            <div class="product-barcode-compact" id="modalPriceBarcode"></div>
          </div>
          <div class="product-name-compact" id="modalPriceName"></div>
        </div>

        <div style="text-align:center;color:#34c759;font-size:24px;margin:12px 0;">‚¨á</div>

        <div class="product-compact">
          <div class="product-header-compact">
            <span class="product-badge">üì¶ –ë–ê–ó–ê</span>
            <div class="product-barcode-compact" id="modalMainBarcode"></div>
          </div>
          <div class="product-name-compact" id="modalMainName"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()"></button>
      </div>
    </div>
  </div>

  <script>


    let jsonData = {};
    let priceData = [];
    let allMatches = [];
    let matchResults = [];
    let skippedItems = [];
    let highMatches = [];
    let reviewItems = [];   // –ù–û–í–û–ï: —Å—Ä–µ–¥–Ω–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è 40-60%
    let changesMap = new Map();
    let pendingAction = null;
    let currentView = 'high';

    const BARCODE_COLS = ['—à—Ç—Ä–∏—Ö–∫–æ–¥', '—à—Ç—Ä–∏—Ö-–∫–æ–¥', 'barcode', '–®–ö', '—à–∫', '–∫–æ–¥', 'ean', '–®—Ç—Ä–∏—Ö–∫–æ–¥'];
    const NAME_COLS = ['–Ω–∞–∑–≤–∞–Ω–∏–µ', 'name', '—Ç–æ–≤–∞—Ä', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ø—Ä–æ–¥—É–∫—Ç', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'];
    const SYNONYM_COLS = ['—Å–∏–Ω–æ–Ω–∏–º—ã', 'synonyms', '—Å–∏–Ω–æ–Ω–∏–º', 'synonym', '–°–∏–Ω–æ–Ω–∏–º—ã'];

    const SIMILARITY_THRESHOLD = 42;   // –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ"
    const REVIEW_THRESHOLD = 60;       // –≤—ã—à–µ ‚Äî "–ù–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã"
    const HIGH_THRESHOLD = 80;         // –≤—ã—à–µ ‚Äî "–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å"

    // ===== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –°–õ–û–í–ê–†–ò =====
    const BRAND_SYNONYMS = {
      'nescafe':    ['–Ω–µ—Å–∫–∞—Ñ–µ','nescafe','neskafe','–Ω–µ—Å–∫–∞—Ñ—ç'],
      'jacobs':     ['—è–∫–æ–±—Å','jacobs','jacobz','jakobs','—è–∫–æ–±—Å'],
      'orbit':      ['–æ—Ä–±–∏—Ç','orbit','–∞—Ä–±–∏—Ç'],
      'dirol':      ['–¥–∏—Ä–æ–ª','dirol','–¥–∏—Ä–æ–ª–ª'],
      'snickers':   ['—Å–Ω–∏–∫–µ—Ä—Å','snickers','—Å–Ω–∏–∫–µ—Ä–∑'],
      'mars':       ['–º–∞—Ä—Å','mars'],
      'twix':       ['—Ç–≤–∏–∫—Å','twix'],
      'milka':      ['–º–∏–ª–∫–∞','milka'],
      'kitkat':     ['–∫–∏—Ç-–∫–∞—Ç','–∫–∏—Ç–∫–∞—Ç','kitkat','kit kat','kit-kat'],
      'oreo':       ['–æ—Ä–µ–æ','oreo'],
      'bounty':     ['–±–∞—É–Ω—Ç–∏','bounty'],
      'raffaello':  ['—Ä–∞—Ñ–∞—ç–ª–ª–æ','raffaello','—Ä–∞—Ñ–∞—ç–ªo'],
      'ferrero':    ['—Ñ–µ—Ä—Ä–µ—Ä–æ','ferrero'],
      'ritter':     ['—Ä–∏—Ç—Ç–µ—Ä','ritter'],
      'nestle':     ['–Ω–µ—Å—Ç–ª–µ','nestle','–Ω–µ—Å—Ç–ª√©'],
      'lipton':     ['–ª–∏–ø—Ç–æ–Ω','lipton'],
      'greenfield': ['–≥—Ä–∏–Ω—Ñ–∏–ª–¥','greenfield'],
      'richard':    ['—Ä–∏—á–∞—Ä–¥','richard'],
      'ahmad':      ['–∞—Ö–º–∞–¥','ahmad'],
      'pringles':   ['–ø—Ä–∏–Ω–≥–ª—Å','pringles'],
      'lays':       ['–ª–µ–π—Å','lays','lay\'s'],
      'cheetos':    ['—á–∏—Ç–æ—Å','cheetos'],
      'doritos':    ['–¥–æ—Ä–∏—Ç–æ—Å','doritos'],
      'lay':        ['–ª–µ–π','lay'],
      'haribo':     ['—Ö–∞—Ä–∏–±–æ','haribo'],
      'fazer':      ['—Ñ–∞—Ü–µ—Ä','fazer'],
      'alpen':      ['–∞–ª—å–ø–µ–Ω','alpen'],
      'alpengold':  ['–∞–ª—å–ø–µ–Ω–≥–æ–ª–¥','alpen gold','alpengold','alpengold'],
      'kinder':     ['–∫–∏–Ω–¥–µ—Ä','kinder'],
      'trolli':     ['—Ç—Ä–æ–ª–ª–∏','trolli'],
      'wrigley':    ['—Ä–∏–≥–ª–∏','wrigley'],
      'dirol':      ['–¥–∏—Ä–æ–ª','dirol'],
      'extra':      ['—ç–∫—Å—Ç—Ä–∞','extra'],
      'mentos':     ['–º–µ–Ω—Ç–æ—Å','mentos'],
      'tic-tac':    ['—Ç–∏–∫ —Ç–∞–∫','tictac','tic tac','tik tak'],
      'halls':      ['—Ö–æ–ª–ª—Å','halls','—Öo–ª–ª—Å'],
      'werther':    ['–≤–µ—Ä—Ç–µ—Ä','werther'],
      'roshen':     ['—Ä–æ—à–µ–Ω','roshen'],
      'svetoch':    ['—Å–≤–µ—Ç–æ—á','svetoch'],
      'rot front':  ['—Ä–æ—Ç —Ñ—Ä–æ–Ω—Ç','rot front','—Ä–æ—Ç—Ñ—Ä–æ–Ω—Ç'],
      'babaevsky':  ['–±–∞–±–∞–µ–≤—Å–∫–∏–π','babaevsky'],
      'kremlevsky': ['–∫—Ä–µ–º–ª–µ–≤—Å–∫–∏–π','kremlevsky'],
      'toblerone':  ['—Ç–æ–±–ª–µ—Ä–æ–Ω','toblerone'],
      'lindt':      ['–ª–∏–Ω–¥—Ç','lindt'],
      'godiva':     ['–≥–æ–¥–∏–≤–∞','godiva'],
      'perugina':   ['–ø–µ—Ä—É–¥–∂–∏–Ω–∞','perugina'],
    };

    const FLAVOR_SYNONYMS = {
      'chicken':      ['–∫—É—Ä–∏—Ü–∞','–∫—É—Ä–∏–Ω—ã–π','–∫—É—Ä–∏–Ω','chicken','chiken'],
      'beef':         ['–≥–æ–≤—è–¥–∏–Ω–∞','–≥–æ–≤—è–∂–∏–π','beef','–≥–æ–≤—è–¥'],
      'vanilla':      ['–≤–∞–Ω–∏–ª—å','vanilla','–≤–∞–Ω–∏–ª—å–Ω—ã–π','–≤–∞–Ω–∏–ª—å','vanila'],
      'chocolate':    ['—à–æ–∫–æ–ª–∞–¥','chocolate','—à–æ–∫–æ–ª–∞–¥–Ω—ã–π','choco','chokolate'],
      'mint':         ['–º—è—Ç–∞','mint','–º—è—Ç–Ω—ã–π','–º—è—Ç—ã'],
      'strawberry':   ['–∫–ª—É–±–Ω–∏–∫–∞','–∫–ª—É–±–Ω–∏—á–Ω—ã–π','strawberry','strawbery'],
      'raspberry':    ['–º–∞–ª–∏–Ω–∞','–º–∞–ª–∏–Ω–æ–≤—ã–π','raspberry'],
      'blueberry':    ['—á–µ—Ä–Ω–∏–∫–∞','—á–µ—Ä–Ω–∏—á–Ω—ã–π','blueberry'],
      'cherry':       ['–≤–∏—à–Ω—è','–≤–∏—à–Ω–µ–≤—ã–π','cherry','–≤–∏—à–Ω—è'],
      'lemon':        ['–ª–∏–º–æ–Ω','–ª–∏–º–æ–Ω–Ω—ã–π','lemon','–ª–∏–º–æ–Ω'],
      'orange':       ['–∞–ø–µ–ª—å—Å–∏–Ω','–∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π','orange','–∞–ø–µ–ª—å—Å'],
      'peach':        ['–ø–µ—Ä—Å–∏–∫','–ø–µ—Ä—Å–∏–∫–æ–≤—ã–π','peach'],
      'mango':        ['–º–∞–Ω–≥–æ','mango'],
      'caramel':      ['–∫–∞—Ä–∞–º–µ–ª—å','–∫–∞—Ä–∞–º–µ–ª—å–Ω—ã–π','caramel','karamel'],
      'hazelnut':     ['–æ—Ä–µ—Ö','–æ—Ä–µ—Ö–æ–≤—ã–π','—Ñ—É–Ω–¥—É–∫','hazelnut'],
      'almond':       ['–º–∏–Ω–¥–∞–ª—å','–º–∏–Ω–¥–∞–ª—å–Ω—ã–π','almond'],
      'cream':        ['—Å–ª–∏–≤–æ—á–Ω—ã–π','cream','—Å–ª–∏–≤–∫–∏','–∫—Ä–µ–º'],
      'mocha':        ['–º–æ–∫–∫–æ','–º–æ–∫–∞','mocha'],
      'espresso':     ['—ç—Å–ø—Ä–µ—Å—Å–æ','espresso'],
      'cappuccino':   ['–∫–∞–ø—É—á–∏–Ω–æ','cappuccino','–∫–∞–ø–ø—É—á–∏–Ω–æ'],
      'latte':        ['–ª–∞—Ç—Ç–µ','latte'],
      'americano':    ['–∞–º–µ—Ä–∏–∫–∞–Ω–æ','americano'],
      'menthol':      ['–º–µ–Ω—Ç–æ–ª','mentol','menthol','–º–µ–Ω—Ç–æ–ª'],
      'eucalyptus':   ['—ç–≤–∫–∞–ª–∏–ø—Ç','eucalyptus'],
      'watermelon':   ['–∞—Ä–±—É–∑','watermelon'],
      'apple':        ['—è–±–ª–æ–∫–æ','—è–±–ª–æ—á–Ω—ã–π','apple'],
      'grape':        ['–≤–∏–Ω–æ–≥—Ä–∞–¥','–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π','grape'],
      'pineapple':    ['–∞–Ω–∞–Ω–∞—Å','–∞–Ω–∞–Ω–∞—Å–æ–≤—ã–π','pineapple'],
      'coconut':      ['–∫–æ–∫–æ—Å','–∫–æ–∫–æ—Å–æ–≤—ã–π','coconut'],
      'cinnamon':     ['–∫–æ—Ä–∏—Ü–∞','cinamon','cinnamon'],
      'ginger':       ['–∏–º–±–∏—Ä—å','–∏–º–±–∏—Ä–Ω—ã–π','ginger'],
      'honey':        ['–º—ë–¥','–º–µ–¥','honey'],
    };

    const PACKAGING_NORM = {
      '—Å—Ç–±':'—Å—Ç–±','—Å—Ç/–±':'—Å—Ç–±','—Å/–±':'—Å—Ç–±','—Å—Ç–µ–∫–ª–æ':'—Å—Ç–±','—Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è':'—Å—Ç–±',
      '–º—É':'–º—É','–º/—É':'–º—É','–º–µ—Ç–∞–ª–ª':'–º—É','–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è':'–º—É',
      '–∂–±':'–∂–±','–∂/–±':'–∂–±','–∂–µ—Å—Ç—è–Ω–∞—è':'–∂–±','–∂–µ—Å—Ç—è–Ω–∞—è –±–∞–Ω–∫–∞':'–∂–±',
      '–ø—ç—Ç':'–ø—ç—Ç','–ø–µ—Ç':'–ø—ç—Ç','–ø–ª–∞—Å—Ç–∏–∫':'–ø—ç—Ç','–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è':'–ø—ç—Ç',
      '—Ç–±':'—Ç–±','—Ç/–±':'—Ç–±','—Ç–µ—Ç—Ä–∞':'—Ç–±','—Ç–µ—Ç—Ä–∞–ø–∞–∫':'—Ç–±',
      '–¥–æ—É –ø–∞–∫':'–¥–æ—É–ø–∞–∫','–¥–æ—É–ø–∞–∫':'–¥–æ—É–ø–∞–∫','–¥–æ–π-–ø–∞–∫':'–¥–æ—É–ø–∞–∫','–¥–æ–π–ø–∞–∫':'–¥–æ—É–ø–∞–∫',
      '–∫–≥':'–∫–≥','–≥':'–≥','–≥—Ä':'–≥','–º–ª':'–º–ª','–ª':'–ª',
    };

    const IGNORE_PATTERNS = [
      /\([^)]*\)/g,
      /\d+—Ö\d+/g,
      /!!!.*?!!!/g,
      /\b–∞–∫—Ü–∏—è\b/gi,
      /\bnew\b/gi,
    ];

    // –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    const SYNONYM_TO_BASE = {};
    for (const [base, syns] of Object.entries(BRAND_SYNONYMS))
      for (const s of syns) SYNONYM_TO_BASE[s.toLowerCase()] = base;

    const FLAVOR_TO_BASE = {};
    for (const [base, syns] of Object.entries(FLAVOR_SYNONYMS))
      for (const s of syns) FLAVOR_TO_BASE[s.toLowerCase()] = base;

    // ===== –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø (RU ‚Üî EN) =====
    const RU_TO_EN = {
      '–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z',
      '–∏':'i','–π':'j','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r',
      '—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'ts','—á':'ch','—à':'sh','—â':'sch',
      '—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'
    };
    const EN_TO_RU_APPROX = {
      'a':'–∞','b':'–±','c':'—Å','d':'–¥','e':'–µ','f':'—Ñ','g':'–≥','h':'—Ö','i':'–∏',
      'j':'–π','k':'–∫','l':'–ª','m':'–º','n':'–Ω','o':'–æ','p':'–ø','r':'—Ä','s':'—Å',
      't':'—Ç','u':'—É','v':'–≤','w':'–≤','x':'–∫—Å','y':'—ã','z':'–∑'
    };

    function toTranslit(str) {
      return str.toLowerCase().split('').map(c => RU_TO_EN[c] !== undefined ? RU_TO_EN[c] : c).join('');
    }

    // –°—Ç–æ–ø-—Å–ª–æ–≤–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–µ—Å—É—Ç —Å–º—ã—Å–ª–∞
    const STOP_WORDS = new Set([
      '–∏','–≤','—Å','–¥–ª—è','–Ω–∞','–æ—Ç','–ø–æ','–∏–∑','–∫','–∑–∞','–æ','–æ–±','–ø—Ä–∏','–¥–æ','–ø–æ–¥',
      '–∏–ª–∏','–Ω–µ','—Ç–æ','—ç—Ç–æ','–∂–µ','–∞','–Ω–æ','–∫–∞–∫','—Ç–∞–∫','–≤—Å–µ','–±','–≥—Ä','—à—Ç','—É–ø','–∞—Ä—Ç','–∫–æ–¥',
      'the','a','an','of','for','with','and','in','to','from','by','at',
    ]);

    function getSignificantTokens(text) {
      return normalizeText(text).split(' ').filter(w => w.length > 1 && !STOP_WORDS.has(w));
    }

    // –ö—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –µ—Å–ª–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ –Ω–∞ RU, –¥—Ä—É–≥–æ–µ –Ω–∞ EN ‚Äî —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä—É–µ–º –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
    function crossLangSimilarity(tok1, tok2) {
      if (tok1 === tok2) return 1;
      const t1 = toTranslit(tok1);
      const t2 = toTranslit(tok2);
      if (t1 === t2) return 1;
      // Jaro-Winkler –Ω–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
      const jw = jaroWinkler(t1, t2);
      return jw;
    }

    // –ß–∏—Å–ª–æ–≤—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ‚Äî –≤—Å–µ —á–∏—Å–ª–∞ –≤ —Ç–µ–∫—Å—Ç–µ
    function extractNumbers(text) {
      const matches = normalizeText(text).match(/\d+(?:\.\d+)?/g) || [];
      return matches.map(Number);
    }


    function getTrigrams(str) {
      const s = '  ' + str + '  ';
      const trigrams = new Set();
      for (let i = 0; i < s.length - 2; i++)
        trigrams.add(s.slice(i, i+3));
      return trigrams;
    }

    function trigramSimilarity(a, b) {
      if (!a || !b) return 0;
      const ta = getTrigrams(a);
      const tb = getTrigrams(b);
      let common = 0;
      for (const t of ta) if (tb.has(t)) common++;
      return (2 * common) / (ta.size + tb.size);
    }

    // ===== JARO-WINKLER =====
    function jaroWinkler(s1, s2) {
      if (s1 === s2) return 1;
      const len1 = s1.length, len2 = s2.length;
      if (!len1 || !len2) return 0;
      const matchDist = Math.max(Math.floor(Math.max(len1, len2) / 2) - 1, 0);
      const s1Matches = new Array(len1).fill(false);
      const s2Matches = new Array(len2).fill(false);
      let matches = 0, transpositions = 0;
      for (let i = 0; i < len1; i++) {
        const start = Math.max(0, i - matchDist);
        const end = Math.min(i + matchDist + 1, len2);
        for (let j = start; j < end; j++) {
          if (s2Matches[j] || s1[i] !== s2[j]) continue;
          s1Matches[i] = s2Matches[j] = true;
          matches++;
          break;
        }
      }
      if (!matches) return 0;
      let k = 0;
      for (let i = 0; i < len1; i++) {
        if (!s1Matches[i]) continue;
        while (!s2Matches[k]) k++;
        if (s1[i] !== s2[k]) transpositions++;
        k++;
      }
      const jaro = (matches/len1 + matches/len2 + (matches-transpositions/2)/matches) / 3;
      let prefix = 0;
      for (let i = 0; i < Math.min(4, len1, len2); i++) {
        if (s1[i] === s2[i]) prefix++; else break;
      }
      return jaro + prefix * 0.1 * (1 - jaro);
    }

    // ===== –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø =====
    function cleanText(text) {
      let cleaned = String(text || '');
      for (const p of IGNORE_PATTERNS) cleaned = cleaned.replace(p, ' ');
      return cleaned.trim();
    }

    function normalizeText(text) {
      return cleanText(text)
        .toLowerCase()
        .replace(/—ë/g, '–µ')
        .replace(/[^–∞-—èa-z0-9.,]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // –ò–∑–≤–ª–µ—á—å –≤–µ—Å/–æ–±—ä—ë–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –µ–¥–∏–Ω–∏—Ü
    function extractWeight(text) {
      const raw = String(text).toLowerCase().replace(/,/g, '.');
      // –ü–∞—Ç—Ç–µ—Ä–Ω—ã: 100–≥, 1.5–∫–≥, 200–º–ª, 1–ª, 0.5 –ª, 500 –≥ –∏ —Ç.–¥.
      const m = raw.match(/(\d+(?:\.\d+)?)\s*(–∫–≥|–≥—Ä|–≥|–º–ª|–ª)\b/);
      if (!m) return null;
      let val = parseFloat(m[1]);
      let unit = m[2];
      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ –≥—Ä–∞–º–º–∞–º/–º–∏–ª–ª–∏–ª–∏—Ç—Ä–∞–º
      if (unit === '–∫–≥') { val *= 1000; unit = '–≥'; }
      if (unit === '–≥—Ä') unit = '–≥';
      if (unit === '–ª') { val *= 1000; unit = '–º–ª'; }
      return { value: val, unit };
    }

    function extractBrand(text) {
      const norm = normalizeText(text);
      for (const word of norm.split(' ')) {
        if (SYNONYM_TO_BASE[word]) return SYNONYM_TO_BASE[word];
      }
      // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–≤—É—Ö—Å–ª–æ–≤–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
      const words = norm.split(' ');
      for (let i = 0; i < words.length - 1; i++) {
        const two = words[i] + ' ' + words[i+1];
        if (SYNONYM_TO_BASE[two]) return SYNONYM_TO_BASE[two];
      }
      return null;
    }

    function extractFlavors(text) {
      const norm = normalizeText(text);
      const result = new Set();
      for (const word of norm.split(' ')) {
        if (FLAVOR_TO_BASE[word]) result.add(FLAVOR_TO_BASE[word]);
      }
      return result;
    }

    function extractPackaging(text) {
      const norm = normalizeText(text);
      for (const [variant, base] of Object.entries(PACKAGING_NORM)) {
        if (norm.includes(variant)) return base;
      }
      return null;
    }

    // ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–†–ê–í–ù–ï–ù–ò–Ø =====
    function calculateSimilarity(text1, text2) {
      const norm1 = normalizeText(text1);
      const norm2 = normalizeText(text2);

      let score = 0;
      const details = [];
      const matchedTokens = new Set();
      const tags = [];

      // 1. –ë—Ä–µ–Ω–¥ (0 –∏–ª–∏ 30)
      const brand1 = extractBrand(text1);
      const brand2 = extractBrand(text2);
      const brandMatch = brand1 && brand2 && brand1 === brand2;
      if (brandMatch) {
        score += 30;
        tags.push('üè∑Ô∏è –ë—Ä–µ–Ω–¥');
        details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 30, matched: true });
        matchedTokens.add(brand1);
      } else {
        details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 0, matched: false });
      }

      // 2. –í–µ—Å ‚Äî –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê
      const w1 = extractWeight(text1);
      const w2 = extractWeight(text2);
      let weightPenalty = false;
      if (w1 && w2) {
        if (w1.unit === w2.unit && Math.abs(w1.value - w2.value) < 1) {
          score += 25;
          tags.push('‚öñÔ∏è –í–µ—Å=');
          details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 25, matched: true });
          matchedTokens.add(w1.value + w1.unit);
        } else {
          // –†–∞–∑–Ω—ã–π –≤–µ—Å ‚Äî —Å–∏–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä
          score -= 40;
          weightPenalty = true;
          tags.push('‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–µ—Å');
          details.push({ component: '‚öñÔ∏è –í–µ—Å', score: -40, matched: false, penalty: true });
        }
      } else if (!w1 && !w2) {
        details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 0, matched: false });
      } else {
        details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 0, matched: false });
      }

      // 3. –í–∫—É—Å—ã (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ)
      const f1 = extractFlavors(text1);
      const f2 = extractFlavors(text2);
      const commonFlavors = [...f1].filter(f => f2.has(f));
      const missingFlavors = [...f1].filter(f => !f2.has(f)).concat([...f2].filter(f => !f1.has(f)));
      if (commonFlavors.length > 0 && missingFlavors.length === 0) {
        score += 15;
        tags.push('üçì –í–∫—É—Å=');
        details.push({ component: 'üçì –í–∫—É—Å', score: 15, matched: true });
        commonFlavors.forEach(f => matchedTokens.add(f));
      } else if (f1.size > 0 && f2.size > 0 && missingFlavors.length > 0) {
        score -= 10;
        details.push({ component: 'üçì –í–∫—É—Å', score: -10, matched: false, penalty: true });
        tags.push('‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–∫—É—Å');
      } else {
        details.push({ component: 'üçì –í–∫—É—Å', score: 0, matched: false });
      }

      // 4. –¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏
      const pkg1 = extractPackaging(text1);
      const pkg2 = extractPackaging(text2);
      if (pkg1 && pkg2) {
        if (pkg1 === pkg2) {
          score += 10;
          tags.push('üì¶ –£–ø–∞–∫=');
          details.push({ component: 'üì¶ –£–ø–∞–∫–æ–≤–∫–∞', score: 10, matched: true });
        } else {
          score -= 15;
          tags.push('‚ö†Ô∏è –†–∞–∑–Ω–∞—è —É–ø.');
          details.push({ component: 'üì¶ –£–ø–∞–∫–æ–≤–∫–∞', score: -15, matched: false, penalty: true });
        }
      }

      // 5. –¢—Ä–∏–≥—Ä–∞–º–º–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å –≤—Å–µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
      const triSim = trigramSimilarity(norm1, norm2);
      const triScore = Math.round(triSim * 30);
      if (triScore > 0) {
        score += triScore;
        details.push({ component: `üìä –¢—Ä–∏–≥—Ä–∞–º–º—ã`, score: triScore, matched: triScore > 5 });
      }

      // 6. –¢–æ–∫–µ–Ω—ã (–±–µ–∑ —Å—Ç–æ–ø-—Å–ª–æ–≤)
      const tokens1 = getSignificantTokens(text1);
      const tokens2 = getSignificantTokens(text2);
      const tset1 = new Set(tokens1);
      const tset2 = new Set(tokens2);
      const exactCommon = tokens1.filter(w => tset2.has(w) && w.length > 2);
      if (exactCommon.length > 0) {
        const tokScore = Math.min(15, exactCommon.length * 4);
        score += tokScore;
        details.push({ component: 'üìù –°–ª–æ–≤–∞', score: tokScore, matched: true });
        exactCommon.forEach(w => matchedTokens.add(w));
      }

      // 7. –ö—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤–æ–µ + Jaro-Winkler –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö
      let crossScore = 0;
      for (const t1 of tokens1) {
        for (const t2 of tokens2) {
          if (t1 === t2 || t1.length < 3 || t2.length < 3) continue;
          const sim = crossLangSimilarity(t1, t2);
          if (sim > 0.85) {
            const bonus = Math.round((sim - 0.85) * 80);
            crossScore = Math.max(crossScore, bonus);
            matchedTokens.add(t2);
            matchedTokens.add(t1);
          }
        }
      }
      if (crossScore > 0) {
        score += crossScore;
        details.push({ component: 'üåê –ö—Ä–æ—Å—Å-—è–∑—ã–∫', score: crossScore, matched: true });
      }

      // 8. –ß–∏—Å–ª–∞ (–∫—Ä–æ–º–µ –≤–µ—Å–∞) ‚Äî —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª
      const nums1 = extractNumbers(text1).filter(n => n !== (w1 ? w1.value : null) && n > 0);
      const nums2 = extractNumbers(text2).filter(n => n !== (w2 ? w2.value : null) && n > 0);
      const commonNums = nums1.filter(n => nums2.includes(n));
      if (commonNums.length > 0) {
        score += 8;
        details.push({ component: 'üî¢ –ß–∏—Å–ª–∞', score: 8, matched: true });
      }

      // –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 0-100
      const maxPossible = 118;
      const finalPercent = Math.max(0, Math.min(100, Math.round(score / maxPossible * 100)));

      return {
        score: finalPercent,
        rawScore: score,
        details,
        tags,
        matchedTokens,
        weightPenalty,
        weights: { w1, w2 }
      };
    }


    document.getElementById('jsonInput').addEventListener('change', handleBaseUpload);
    document.getElementById('priceInput').addEventListener('change', handlePriceUpload);

    async function handleBaseUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      try {
        showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã —Å–∏–Ω–æ–Ω–∏–º–æ–≤...');

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.json')) {
          // JSON —Ñ–æ—Ä–º–∞—Ç
          const text = await file.text();
          jsonData = JSON.parse(text);
        } else if (fileName.endsWith('.csv')) {
          // CSV —Ñ–æ—Ä–º–∞—Ç
          const data = await parseCSV(file);
          jsonData = convertTableToJSON(data);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
          // Excel —Ñ–æ—Ä–º–∞—Ç
          const data = await parseExcel(file);
          jsonData = convertTableToJSON(data);
        } else {
          throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }

        document.getElementById('jsonBox').classList.add('loaded');
        document.getElementById('jsonStatus').textContent = `‚úì ${Object.keys(jsonData).length} –∑–∞–ø–∏—Å–µ–π`;

        hideProgress();
        checkAndAnalyze();
      } catch (error) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã: ' + error.message);
      }
    }

    function convertTableToJSON(data) {
      const result = {};

      if (!data || data.length === 0) {
        throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
      }

      // –ò—â–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      const barcodeCol = findColumn(data, BARCODE_COLS);
      const nameCol = findColumn(data, NAME_COLS);
      const synonymCol = findColumn(data, SYNONYM_COLS);

      if (!barcodeCol || !nameCol) {
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –®—Ç—Ä–∏—Ö–∫–æ–¥ –∏ –ù–∞–∑–≤–∞–Ω–∏–µ');
      }

      for (const row of data) {
        const barcode = String(row[barcodeCol] || '').trim();
        const name = String(row[nameCol] || '').trim();
        const synonyms = synonymCol ? String(row[synonymCol] || '').trim() : '';

        if (barcode && name) {
          result[barcode] = [name, synonyms];
        }
      }

      return result;
    }

    async function handlePriceUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      try {
        showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...');

        if (file.name.toLowerCase().endsWith('.csv')) {
          priceData = await parseCSV(file);
        } else {
          priceData = await parseExcel(file);
        }

        document.getElementById('priceBox').classList.add('loaded');
        document.getElementById('priceStatus').textContent = `‚úì ${priceData.length} —Ç–æ–≤–∞—Ä–æ–≤`;

        hideProgress();
        checkAndAnalyze();
      } catch (error) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: ' + error.message);
      }
    }

    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (error) => reject(error)
        });
      });
    }

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function checkAndAnalyze() {
      if (Object.keys(jsonData).length > 0 && priceData.length > 0) {
        performEnhancedMatching();
      }
    }

    function findColumn(data, synonyms) {
      if (!data || data.length === 0) return null;
      const columns = Object.keys(data[0]);
      return columns.find(col => synonyms.some(syn => col.toLowerCase().includes(syn.toLowerCase()))) || columns[0];
    }

    // (cleanText, normalizeText, extractWeight, extractBrand, extractFlavors, extractPackaging
    //  calculateSimilarity ‚Äî –≤—Å—ë –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤—ã—à–µ, –≤ –Ω–æ–≤–æ–º –±–ª–æ–∫–µ)

    function highlightMatches(text, matchedTokens) {
      if (!matchedTokens || matchedTokens.size === 0) return text;
      let result = text;
      for (const token of matchedTokens) {
        try {
          const regex = new RegExp(`(${token.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
          result = result.replace(regex, '<span class="highlight">$1</span>');
        } catch(e) {}
      }
      return result;
    }

    function isBarcode(str) {
      return /^\d{8,14}$/.test(String(str).trim());
    }

    function showProgress(text) {
      document.getElementById('progressBar').classList.add('show');
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressFill').style.width = '0%';
    }

    function updateProgress(percent) {
      document.getElementById('progressFill').style.width = percent + '%';
    }

    function hideProgress() {
      document.getElementById('progressBar').classList.remove('show');
    }

    async function performEnhancedMatching() {
      showProgress('–£–º–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥ V3.0 ‚Äî —Ç—Ä–∏–≥—Ä–º–º–Ω—ã–π –ø–æ–∏—Å–∫...');
      matchResults = [];
      skippedItems = [];
      highMatches = [];
      reviewItems = [];
      allMatches = [];

      const barcodeCol = findColumn(priceData, BARCODE_COLS);
      const nameCol = findColumn(priceData, NAME_COLS);

      if (!barcodeCol || !nameCol) {
        hideProgress();
        alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã "–®—Ç—Ä–∏—Ö–∫–æ–¥" –∏ "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" –≤ –ø—Ä–∞–π—Å–µ');
        return;
      }

      const jsonMap = new Map();
      const allBarcodes = new Set();

      for (const [key, value] of Object.entries(jsonData)) {
        const keyIsBarcode = isBarcode(key);
        let name = key;
        let mainBarcode = keyIsBarcode ? key : '';
        let synonyms = [];

        if (Array.isArray(value)) {
          if (value.length > 0 && value[0]) name = String(value[0]).trim();
          if (value.length > 2) {
            synonyms = value.slice(1).map(s => String(s).trim()).filter(s => s && isBarcode(s));
          } else if (value.length === 2 && value[1]) {
            const synonymsStr = String(value[1]).trim();
            if (synonymsStr) synonyms = synonymsStr.split(';').map(s => s.trim()).filter(s => s && isBarcode(s));
          }
        }

        jsonMap.set(key, { hasMainBarcode: keyIsBarcode, mainBarcode, name, synonyms });
        if (keyIsBarcode) allBarcodes.add(key);
        synonyms.forEach(syn => allBarcodes.add(syn));
      }

      for (let i = 0; i < priceData.length; i++) {
        const row = priceData[i];
        const barcode = String(row[barcodeCol] || '').trim();
        const name = String(row[nameCol] || '').trim();

        if (!barcode || !name) continue;

        // –°–æ–±–∏—Ä–∞–µ–º –¢–û–ü-3 –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        const candidates = [];

        for (const [key, data] of jsonMap) {
          const result = calculateSimilarity(name, data.name);
          if (result.score >= SIMILARITY_THRESHOLD) {
            candidates.push({
              key, ...data,
              similarity: result.score,
              matchResult: result
            });
          }
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ score, –±–µ—Ä—ë–º —Ç–æ–ø-3
        candidates.sort((a, b) => b.similarity - a.similarity);
        const top3 = candidates.slice(0, 3);
        const bestMatch = top3[0];

        if (bestMatch) {
          const isDuplicate = allBarcodes.has(barcode);
          const sim = bestMatch.similarity;

          if (isDuplicate) {
            skippedItems.push({
              barcode, name,
              reason: 'duplicate',
              matchName: bestMatch.name,
              mainBarcode: bestMatch.mainBarcode,
              similarity: sim,
              matchResult: bestMatch.matchResult,
              candidates: top3
            });
          } else {
            const matchData = {
              barcode, name,
              mainBarcode: bestMatch.mainBarcode,
              mainName: bestMatch.name,
              synonyms: bestMatch.synonyms,
              hasMainBarcode: bestMatch.hasMainBarcode,
              jsonKey: bestMatch.key,
              similarity: sim,
              matchResult: bestMatch.matchResult,
              candidates: top3,
              weightPenalty: bestMatch.matchResult.weightPenalty
            };

            if (sim >= REVIEW_THRESHOLD) {
              matchResults.push(matchData);
              if (sim >= HIGH_THRESHOLD) highMatches.push(matchData);
            } else {
              reviewItems.push(matchData);
            }
          }

          allMatches.push({ barcode, name, status: isDuplicate ? 'skipped' : 'new', similarity: sim, matchResult: bestMatch.matchResult });
        }

        if (i % 10 === 0) {
          updateProgress((i / priceData.length) * 100);
          await new Promise(resolve => setTimeout(resolve, 0));
        }
      }

      matchResults.sort((a, b) => b.similarity - a.similarity);
      reviewItems.sort((a, b) => b.similarity - a.similarity);

      document.getElementById('statTotal').textContent = priceData.length;
      document.getElementById('statNew').textContent = matchResults.length;
      document.getElementById('statHigh').textContent = highMatches.length;
      document.getElementById('statReview').textContent = reviewItems.length;
      document.getElementById('statSkipped').textContent = skippedItems.length;

      document.getElementById('statsBar').classList.add('show');
      document.getElementById('resultsPanel').classList.add('show');

      hideProgress();
      filterByView('high');
    }

    function filterByView(view) {
      currentView = view;

      document.querySelectorAll('.stat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) item.classList.add('active');
      });

      if (view === 'high') {
        document.getElementById('resultsTitle').textContent = '‚≠ê –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (‚â•80%)';
        document.getElementById('resultsSubtitle').textContent = `${highMatches.length} —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å–∏–Ω–æ–Ω–∏–º—ã`;
        renderResults(highMatches, 'match');
      } else if (view === 'new') {
        document.getElementById('resultsTitle').textContent = 'üìä –ù–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã (60‚Äì79%)';
        document.getElementById('resultsSubtitle').textContent = `${matchResults.filter(r=>r.similarity<HIGH_THRESHOLD).length} —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ö–æ—Ä–æ—à–∏–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º`;
        renderResults(matchResults.filter(r=>r.similarity<HIGH_THRESHOLD), 'match');
      } else if (view === 'review') {
        document.getElementById('resultsTitle').textContent = 'üîç –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ (42‚Äì59%) ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å–∞–º–∏';
        document.getElementById('resultsSubtitle').textContent = `${reviewItems.length} —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –≤—ã —Ä–µ—à–∞–µ—Ç–µ`;
        renderResults(reviewItems, 'review');
      } else if (view === 'skipped') {
        document.getElementById('resultsTitle').textContent = '‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ (–¥—É–±–ª–∏)';
        document.getElementById('resultsSubtitle').textContent = `${skippedItems.length} —Ç–æ–≤–∞—Ä–æ–≤ —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ`;
        renderResults(skippedItems, 'skipped');
      } else {
        document.getElementById('resultsTitle').textContent = 'üìã –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è';
        document.getElementById('resultsSubtitle').textContent = `${allMatches.length} —Ç–æ–≤–∞—Ä–æ–≤`;
        renderResults(allMatches, 'all');
      }
    }

    function renderResults(items, type) {
      const container = document.getElementById('resultsList');

      if (items.length === 0) {
        let emptyText = '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
        if (type === 'new') emptyText = '–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        if (type === 'skipped') emptyText = '–ù–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤';
        if (type === 'high') emptyText = '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ö–æ–∂–µ—Å—Ç—å—é';

        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úì</div>
            <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${emptyText}</div>
          </div>
        `;
        return;
      }

      let html = '';

      items.forEach((item, index) => {
        const result = item;
        const sim = result.similarity || 0;
        const mr = result.matchResult || {};

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏
        let cardClass, simClass, actionLabel, actionClass;
        if (type === 'skipped') {
          cardClass = 'skipped-card'; simClass = 'skip'; actionLabel = '‚è≠Ô∏è –î—É–±–ª—å'; actionClass = 'action-skip';
        } else if (type === 'review') {
          cardClass = 'review-card'; simClass = 'review'; actionLabel = 'üîç –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'; actionClass = 'action-review';
        } else {
          cardClass = sim >= 80 ? 'high-match' : 'medium-match';
          simClass = sim >= 80 ? 'high' : 'medium';
          actionLabel = result.hasMainBarcode ? '‚ûï –°–∏–Ω–æ–Ω–∏–º' : '‚≠ê –ì–ª–∞–≤–Ω—ã–π';
          actionClass = result.hasMainBarcode ? 'action-synonym' : 'action-main';
        }

        const matchTags = (mr.tags || []).map(t => `<span class="match-tag">${t}</span>`).join('');
        const mainName = type === 'skipped' ? (result.matchName || '') : (result.mainName || '');
        const highlightedPriceName = highlightMatches(result.name, mr.matchedTokens);
        const highlightedJsonName = highlightMatches(mainName, mr.matchedTokens);

        // –î–µ—Ç–∞–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        let scoreDetails = '';
        if (mr.details) {
          scoreDetails = mr.details.filter(d => d.score !== 0).map(d =>
            `<span class="score-item" style="${d.penalty ? 'background:#fff0f0' : ''}">
              <span class="score-icon">${d.component.split(' ')[0]}</span>
              <span style="color:${d.penalty ? '#ff3b30' : '#34c759'}">${d.score > 0 ? '+' : ''}${d.score}</span>
            </span>`
          ).join('');
        }

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∞–∑–Ω–æ–º –≤–µ—Å–µ
        const weightWarn = result.weightPenalty || mr.weightPenalty ?
          `<div class="weight-warning">‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–µ—Å ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–∞–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã!</div>` : '';

        // –ë–ª–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–¥–ª—è review –∏ –æ–±—ã—á–Ω—ã—Ö —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏)
        let candidatesHtml = '';
        if (result.candidates && result.candidates.length > 1) {
          const cands = result.candidates.slice(0, 3).map((c, ci) => {
            const cSim = c.similarity;
            const cColor = cSim >= 80 ? '#34c759' : cSim >= 60 ? '#ff9500' : '#af52de';
            const isMain = ci === 0;
            return `
              <div class="candidate-item ${isMain ? 'selected' : ''}" 
                   onclick="selectCandidate(event, ${index}, ${ci}, '${type}')">
                <span class="candidate-score" style="background:${cColor}">${cSim}%</span>
                <span class="candidate-name">${c.name}</span>
                <span class="candidate-bc">${c.mainBarcode || c.key || ''}</span>
                ${type !== 'skipped' ? `<button class="select-candidate-btn" onclick="selectAndConfirm(event,${index},${ci},'${type}')">–í—ã–±—Ä–∞—Ç—å</button>` : ''}
              </div>
            `;
          }).join('');
          candidatesHtml = `
            <div class="candidates-section">
              <div class="candidates-title">üîé –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (${result.candidates.length} –Ω–∞–π–¥–µ–Ω–æ)</div>
              ${cands}
            </div>
          `;
        }

        const clickable = type !== 'skipped' ? `onclick="showConfirmModal(${index}, '${type}')"` : '';

        html += `
          <div class="result-card ${cardClass}" ${clickable}>
            <div class="card-header">
              <div class="card-left">
                <span class="similarity-badge similarity-${simClass}">${sim}%</span>
                <div class="match-tags">${matchTags}</div>
              </div>
              <span class="action-badge ${actionClass}">${actionLabel}</span>
            </div>

            <div class="comparison-vertical">
              <div class="name-box price-box">
                <div class="name-label"><span>üìÑ</span><span>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</span></div>
                <div class="name-text">${highlightedPriceName}</div>
                <div class="barcode-info">–®–ö: ${result.barcode}</div>
              </div>
              <div class="name-box json-box">
                <div class="name-label"><span>üì¶</span><span>–í –±–∞–∑–µ (–ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)</span></div>
                <div class="name-text">${highlightedJsonName}</div>
                <div class="barcode-info">–®–ö: ${result.mainBarcode || result.hasMainBarcode ? (result.mainBarcode || result.key) : '[–ù–µ—Ç –®–ö]'}</div>
              </div>
            </div>

            ${weightWarn}
            ${scoreDetails ? `<div class="score-details">${scoreDetails}</div>` : ''}
            ${candidatesHtml}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
    function selectCandidate(e, itemIndex, candidateIndex, type) {
      e.stopPropagation();
      const list = type === 'high' ? highMatches : type === 'new' ? matchResults.filter(r=>r.similarity<HIGH_THRESHOLD) : reviewItems;
      if (!list[itemIndex] || !list[itemIndex].candidates) return;

      // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞ –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ
      const cands = list[itemIndex].candidates;
      const chosen = cands.splice(candidateIndex, 1)[0];
      cands.unshift(chosen);
      list[itemIndex].mainBarcode = chosen.mainBarcode;
      list[itemIndex].mainName = chosen.name;
      list[itemIndex].hasMainBarcode = chosen.hasMainBarcode;
      list[itemIndex].jsonKey = chosen.key;
      list[itemIndex].similarity = chosen.similarity;
      list[itemIndex].matchResult = chosen.matchResult;
      list[itemIndex].weightPenalty = chosen.matchResult.weightPenalty;

      filterByView(currentView);
    }

    // –í—ã–±—Ä–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    function selectAndConfirm(e, itemIndex, candidateIndex, type) {
      e.stopPropagation();
      selectCandidate(e, itemIndex, candidateIndex, type);
      // –ü–æ—Å–ª–µ selectCandidate —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, candidateIndex 0 —Ç–µ–ø–µ—Ä—å –≤—ã–±—Ä–∞–Ω
      showConfirmModal(itemIndex, type);
    }

    function showConfirmModal(index, type) {
      let list;
      if (type === 'high') list = highMatches;
      else if (type === 'review') list = reviewItems;
      else list = matchResults.filter(r=>r.similarity<HIGH_THRESHOLD);

      const result = list[index];
      if (!result) return;

      pendingAction = result;

      document.getElementById('modalSimilarity').textContent = result.similarity + '%';
      document.getElementById('modalPriceBarcode').textContent = result.barcode;
      document.getElementById('modalPriceName').textContent = result.name.toUpperCase();

      const modalMainBarcode = document.getElementById('modalMainBarcode');
      if (result.hasMainBarcode) {
        modalMainBarcode.textContent = result.mainBarcode;
      } else {
        modalMainBarcode.textContent = '[–ù–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö]';
      }

      document.getElementById('modalMainName').textContent = result.mainName.toUpperCase();

      const actionInfoCompact = document.getElementById('actionInfoCompact');
      const actionTextCompact = document.getElementById('actionTextCompact');
      const confirmBtn = document.getElementById('confirmBtn');

      if (result.hasMainBarcode) {
        actionInfoCompact.className = 'action-info-compact';
        actionTextCompact.textContent = '‚ûï –®—Ç—Ä–∏—Ö–∫–æ–¥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ —Å–∏–Ω–æ–Ω–∏–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–æ–≤–∞—Ä—É';
        confirmBtn.textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º';
      } else {
        actionInfoCompact.className = 'action-info-compact main';
        actionTextCompact.textContent = '‚≠ê –®—Ç—Ä–∏—Ö–∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç –ì–õ–ê–í–ù–´–ú –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—É —Ç–æ–≤–∞—Ä–∞ —Å–µ–π—á–∞—Å –Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö)';
        confirmBtn.textContent = '‚≠ê –°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º';
      }

      document.getElementById('confirmModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('confirmModal').classList.remove('show');
      pendingAction = null;
    }

    function confirmAction() {
      if (!pendingAction) return;

      const action = pendingAction.hasMainBarcode ? 'add_synonym' : 'set_main';

      changesMap.set(pendingAction.barcode, {
        action: action,
        mainBarcode: pendingAction.mainBarcode || '',
        jsonKey: pendingAction.jsonKey || '',
        newBarcode: pendingAction.barcode,
        newName: pendingAction.name,
        mainName: pendingAction.mainName,
        similarity: pendingAction.similarity
      });

      const bc = pendingAction.barcode;
      matchResults = matchResults.filter(r => r.barcode !== bc);
      highMatches = highMatches.filter(r => r.barcode !== bc);
      reviewItems = reviewItems.filter(r => r.barcode !== bc);

      document.getElementById('statNew').textContent = matchResults.length;
      document.getElementById('statHigh').textContent = highMatches.length;
      document.getElementById('statReview').textContent = reviewItems.length;
      document.getElementById('exportTopCount').textContent = changesMap.size;
      document.getElementById('exportTopBtn').classList.add('show');

      closeModal();
      filterByView(currentView);
    }

    async function exportJSON() {
      const updated = JSON.parse(JSON.stringify(jsonData));

      changesMap.forEach((change, barcode) => {
        if (change.action === 'add_synonym') {
          // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º jsonKey ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –∑–∞–ø–∏—Å–∏ –≤ jsonData
          const lookupKey = change.jsonKey || change.mainBarcode;
          const currentData = updated[lookupKey];

          if (Array.isArray(currentData) && currentData.length >= 1) {
            const name = currentData[0];

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —á–∏—Ç–∞–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏–Ω–æ–Ω–∏–º—ã (–æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
            // –§–æ—Ä–º–∞—Ç sinonims_with_nav: ["name","syn1","syn2",...] ‚Äî —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞
            // –§–æ—Ä–º–∞—Ç CSV/XLSX:          ["name","syn1; syn2;..."] ‚Äî —Å—Ç—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ ";"
            let synonyms = [];
            if (currentData.length > 2) {
              synonyms = currentData.slice(1).map(s => String(s).trim()).filter(Boolean);
            } else if (currentData.length === 2 && currentData[1]) {
              synonyms = String(currentData[1]).trim().split(';').map(s => s.trim()).filter(Boolean);
            }

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–∑ –ø—Ä–∞–π—Å–∞ (barcode = –∫–ª—é—á changesMap)
            if (barcode && !synonyms.includes(barcode)) {
              synonyms.push(barcode);
            }

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ sinonims_with_nav ‚Äî ["name", "syn1", "syn2", ...]
            updated[lookupKey] = [name, ...synonyms];
          }
        } else if (change.action === 'set_main') {
          const oldKey = change.jsonKey;
          const oldName = change.mainName;

          updated[barcode] = [oldName];

          if (updated[oldKey]) {
            delete updated[oldKey];
          }
        }
      });

      const json = JSON.stringify(updated, null, 2);
      const timestamp = new Date().toISOString().slice(0, 10);
      const fileName = `synonyms_v2.2_${timestamp}.json`;

      // File System Access API ‚Äî –¥–∏–∞–ª–æ–≥ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫" —Å –≤—ã–±–æ—Ä–æ–º –ø–∞–ø–∫–∏
      if (window.showSaveFilePicker) {
        try {
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: [{ description: 'JSON —Ñ–∞–π–ª', accept: { 'application/json': ['.json'] } }]
          });
          const writable = await fileHandle.createWritable();
          await writable.write(json);
          await writable.close();
          alert(`‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${changesMap.size} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n–§–∞–π–ª: ${fileHandle.name}`);
          return;
        } catch (err) {
          if (err.name === 'AbortError') return;
          console.warn('showSaveFilePicker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:', err);
        }
      }

      // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ File System Access API
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert(`‚úÖ JSON –æ–±–Ω–æ–≤–ª—ë–Ω!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${changesMap.size} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n–§–∞–π–ª: ${fileName}`);
    }

    document.getElementById('confirmModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
  <script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–æ–º+–ø—É—Ç—å —Ü–µ–ª–∏–∫–æ–º
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>

</body>
</html>
