<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Smart Matcher ‚Äî –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
}

.container { max-width: 1600px; margin: 0 auto; }

.header {
  background: white;
  border-radius: 16px;
  padding: 18px 24px;
  margin-bottom: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

h1 {
  font-size: 26px;
  font-weight: 700;
  color: #1c1c1e;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.version-badge {
  background: linear-gradient(135deg, #5856d6 0%, #667eea 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}

.algo-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.algo-badge {
  background: #f2f2f7;
  color: #3c3c43;
  padding: 3px 9px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.subtitle {
  color: #8e8e93;
  font-size: 13px;
  line-height: 1.5;
}

.export-top {
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  border: none;
  padding: 14px 32px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: none;
  margin-top: 16px;
}

.export-top.show { display: inline-block; }
.export-top:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(52, 199, 89, 0.4); }
.export-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }

.stats-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.stats-bar.show { display: block; }

.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

.stat-item {
  text-align: center;
  padding: 16px;
  border-radius: 12px;
  transition: all 0.2s;
  cursor: pointer;
  border: 2px solid transparent;
}

.stat-item:hover {
  background: #f9f9fb;
  border-color: #667eea;
  transform: translateY(-2px);
}

.stat-item.active {
  background: #e8f0ff;
  border-color: #667eea;
}

.stat-value { font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 4px; }
.stat-label { font-size: 12px; color: #8e8e93; text-transform: uppercase; font-weight: 600; }

.results-panel {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.results-panel.show { display: block; }

.results-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f2f2f7;
}

.results-title { font-size: 20px; font-weight: 600; color: #1c1c1e; }
.results-subtitle { font-size: 13px; color: #8e8e93; margin-top: 4px; }

.results-list { max-height: 650px; overflow-y: auto; }

.result-card {
  border: 2px solid #e5e5ea;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  transition: all 0.2s;
  cursor: pointer;
}

.result-card:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  transform: translateY(-1px);
}

.result-card.high-match { border-color: #34c759; background: #f0fdf4; }
.result-card.medium-match { border-color: #ff9500; background: #fff9e6; }
.result-card.skipped-card { border-color: #8e8e93; background: #f9f9fb; }

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.card-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.similarity-badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  color: white;
}

.similarity-high { background: #34c759; }
.similarity-medium { background: #ff9500; }
.similarity-skip { background: #8e8e93; }

.match-tags {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.match-tag {
  background: #e8f0ff;
  color: #667eea;
  padding: 3px 7px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
}

.action-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.action-synonym { background: #ff9500; color: white; }
.action-main { background: #5856d6; color: white; }
.action-skip { background: #8e8e93; color: white; }

.comparison-vertical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.name-box {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  border-left: 4px solid #667eea;
}

.name-box.price-box { border-left-color: #ff9500; }
.name-box.json-box { border-left-color: #34c759; }

.name-label {
  font-size: 11px;
  font-weight: 600;
  color: #8e8e93;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-text {
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
  line-height: 1.4;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.name-norm {
  font-size: 11px;
  color: #8e8e93;
  margin-top: 6px;
  font-family: monospace;
}

.barcode-info {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: #667eea;
  margin-top: 6px;
  font-weight: 600;
}

.highlight {
  background: #d4f4dd;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 700;
  color: #1c7d3a;
}

.score-details {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e5ea;
  font-size: 11px;
  color: #8e8e93;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.score-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #f9f9fb;
  padding: 3px 8px;
  border-radius: 6px;
}

.score-icon { font-size: 12px; }

.empty-state { text-align: center; padding: 60px 20px; color: #8e8e93; }
.empty-icon { font-size: 64px; margin-bottom: 16px; }

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show { display: flex; }

.modal-content {
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 20px 20px 16px 20px;
  border-bottom: 2px solid #f2f2f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title { font-size: 18px; font-weight: 600; color: #1c1c1e; }

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #8e8e93;
  cursor: pointer;
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px;
  transition: all 0.2s;
}

.modal-close:hover { background: #f2f2f7; }
.modal-body { padding: 20px; }

.similarity-info-compact {
  text-align: center;
  padding: 12px;
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  border-radius: 10px;
  margin-bottom: 16px;
}

.similarity-percent-compact { font-size: 28px; font-weight: 700; color: white; }
.similarity-text-compact { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 2px; }

.action-info-compact {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #856404;
}

.action-info-compact.main {
  background: #e8e5ff;
  border-left-color: #5856d6;
  color: #3a38a0;
}

.product-compact {
  background: #f9f9fb;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
}

.product-header-compact {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.product-badge {
  font-size: 11px;
  font-weight: 600;
  color: #667eea;
  background: #e8f0ff;
  padding: 4px 10px;
  border-radius: 12px;
}

.product-barcode-compact {
  font-family: 'Courier New', monospace;
  font-size: 15px;
  font-weight: 700;
  color: #1c1c1e;
}

.product-name-compact {
  font-size: 16px;
  color: #1c1c1e;
  line-height: 1.4;
  margin-top: 6px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.modal-actions {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  padding: 16px 20px;
  border-top: 2px solid #f2f2f7;
}

.modal-btn {
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.cancel { background: #f2f2f7; color: #8e8e93; }
.modal-btn.cancel:hover { background: #e5e5ea; }
.modal-btn.confirm { background: #34c759; color: white; }
.modal-btn.confirm:hover { background: #28a745; transform: translateY(-2px); }

.progress-bar {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: none;
}

.progress-bar.show { display: block; }

.progress-text {
  font-size: 14px;
  color: #1c1c1e;
  margin-bottom: 12px;
  font-weight: 600;
  text-align: center;
}

.progress-track { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #5856d6 0%, #667eea 100%);
  transition: width 0.3s;
  width: 0%;
}

.candidates-section {
  margin-top: 12px;
  border-top: 1px dashed #e5e5ea;
  padding-top: 12px;
}

.candidates-title {
  font-size: 11px;
  font-weight: 700;
  color: #8e8e93;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.candidate-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  border: 1.5px solid transparent;
  transition: all 0.2s;
  background: #f2f2f7;
}

.candidate-item:hover { border-color: #667eea; background: #e8f0ff; }
.candidate-item.selected { border-color: #34c759; background: #f0fdf4; }

.candidate-score {
  font-size: 12px;
  font-weight: 700;
  color: white;
  padding: 2px 7px;
  border-radius: 8px;
  min-width: 40px;
  text-align: center;
  flex-shrink: 0;
}

.candidate-name {
  font-size: 13px;
  font-weight: 600;
  color: #1c1c1e;
  flex: 1;
  text-transform: uppercase;
}

.candidate-bc {
  font-size: 11px;
  color: #667eea;
  font-family: monospace;
  flex-shrink: 0;
}

.result-card.review-card { border-color: #af52de; background: #fdf4ff; }
.similarity-review { background: #af52de; }
.action-review { background: #af52de; color: white; }

.weight-warning {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 11px;
  color: #856404;
  font-weight: 600;
  margin-top: 6px;
}

.select-candidate-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}

.select-candidate-btn:hover { background: #5568d3; }

/* V4.1 skip reason */
.skip-reason-box {
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 10px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: flex-start;
  flex-direction: column;
  gap: 4px;
}
.skip-reason-box.is-main {
  background: #e3f2fd;
  border: 1px solid #90caf9;
  color: #1565c0;
}
.skip-reason-box.is-synonym {
  background: #f3e5f5;
  border: 1px solid #ce93d8;
  color: #7b1fa2;
}
.skip-reason-detail {
  font-size: 11px;
  font-weight: 400;
  opacity: 0.85;
  font-family: monospace;
  word-break: break-all;
}
/* V4.1 rebranding tag */
.tag-rebrand {
  background: #fff3e0;
  color: #bf360c;
  border: 1px solid #ffb74d;
  padding: 2px 7px;
  border-radius: 7px;
  font-size: 10px;
  font-weight: 700;
}

@media (max-width: 768px) {
  .upload-grid { flex-direction: column; }
  .stats-grid { grid-template-columns: repeat(2,1fr) !important; }
  .modal-actions { grid-template-columns: 1fr; }
}

/* ===== NAV ===== */
.global-nav {
  max-width: 1600px;
  margin: 0 auto 16px auto;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.28);
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.global-nav__inner {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.global-nav__brand {
  text-decoration: none;
  font-weight: 800;
  font-size: 14px;
  color: #fff;
  white-space: nowrap;
  opacity: 0.9;
}

.global-nav__links {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

.global-nav__link {
  text-decoration: none;
  font-size: 12px;
  font-weight: 600;
  color: rgba(255,255,255,0.88);
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.28);
  padding: 5px 12px;
  border-radius: 999px;
  white-space: nowrap;
  transition: all .15s ease;
}

.global-nav__link:hover { background: rgba(255,255,255,0.28); color: #fff; transform: translateY(-1px); }
.global-nav__link.is-active { color: #667eea; background: #fff; border-color: #fff; }

/* ===== UPLOAD ===== */
.upload-panel {
  background: white;
  border-radius: 16px;
  padding: 12px 16px;
  margin-bottom: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.upload-grid { display: flex; gap: 10px; align-items: stretch; }

.upload-box {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px dashed #e5e5ea;
  border-radius: 10px;
  padding: 12px 14px;
  transition: all 0.25s;
  cursor: pointer;
}

.upload-box:hover { border-color: #667eea; background: #f9f9fb; }
.upload-box.loaded { border-color: #34c759; background: #f0fdf4; }

.upload-icon { font-size: 24px; flex-shrink: 0; line-height: 1; }
.upload-info { flex: 1; min-width: 0; }
.upload-title { font-size: 13px; font-weight: 700; color: #1c1c1e; margin-bottom: 2px; }
.upload-desc { font-size: 11px; color: #8e8e93; line-height: 1.3; }
.upload-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; flex-shrink: 0; }
.format-badges { display: flex; gap: 4px; }
.format-badge { background: #e8f0ff; color: #667eea; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 700; }

.upload-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 7px;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.upload-btn:hover { background: #5568d3; }
.upload-status { font-size: 11px; color: #34c759; font-weight: 600; white-space: nowrap; text-align: right; }

input[type="file"] { display: none; }
  </style>
</head>
<body style="background:linear-gradient(135deg,#5856d6 0%,#667eea 50%,#764ba2 100%);min-height:100vh;padding:16px;">

<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">üß≠ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">–†–µ–¥–∞–∫—Ç–æ—Ä JSON</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">–û–±—Ä–µ–∑–∞—Ç–µ–ª—å</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">–ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</a>
    </nav>
  </div>
</header>

<div class="container">
  <div class="header">
    <h1>
      üéØ Smart Matcher
      <span class="version-badge">V4.1</span>
    </h1>
    <div class="algo-badges">
      <span class="algo-badge">‚öñÔ∏è –ï–¥–∏–Ω–∏—Ü—ã: 100 GR = 0.1–∫–≥ = 100–≥</span>
      <span class="algo-badge">üîÄ Token Set: –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –Ω–µ –≤–∞–∂–µ–Ω</span>
      <span class="algo-badge">üî§ –§–æ–Ω–µ—Ç–∏–∫–∞: –Ω–µ—Å–∫–∞—Ñ–µ ‚âà nescafe</span>
      <span class="algo-badge">üè∑Ô∏è 150+ –±—Ä–µ–Ω–¥–æ–≤ + —Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥–∏ –†–§</span>
      <span class="algo-badge">üì¶ 20+ —Ç–∏–ø–æ–≤ —É–ø–∞–∫–æ–≤–∫–∏</span>
      <span class="algo-badge">‚ûñ kit-kat = kitkat = kit kat</span>
    </div>
    <button class="export-top" id="exportTopBtn" onclick="exportJSON()">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π JSON <span class="export-count" id="exportTopCount">0</span>
    </button>
  </div>

  <div class="upload-panel">
    <div class="upload-grid">
      <div class="upload-box" id="jsonBox" onclick="document.getElementById('jsonInput').click()">
        <div class="upload-icon">üì¶</div>
        <div class="upload-info">
          <div class="upload-title">–ë–∞–∑–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
          <div class="upload-desc">JSON / CSV / XLSX ¬∑ –®—Ç—Ä–∏—Ö–∫–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –°–∏–Ω–æ–Ω–∏–º—ã</div>
          <div class="upload-status" id="jsonStatus"></div>
        </div>
        <div class="upload-right">
          <div class="format-badges">
            <span class="format-badge">JSON</span>
            <span class="format-badge">CSV</span>
            <span class="format-badge">XLSX</span>
          </div>
          <button class="upload-btn">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
        </div>
        <input type="file" id="jsonInput" accept=".json,.csv,.xlsx,.xls">
      </div>

      <div class="upload-box" id="priceBox" onclick="document.getElementById('priceInput').click()">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-info">
          <div class="upload-title">–ü—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
          <div class="upload-desc">CSV / XLSX ¬∑ –®—Ç—Ä–∏—Ö–∫–æ–¥ | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
          <div class="upload-status" id="priceStatus"></div>
        </div>
        <div class="upload-right">
          <div class="format-badges">
            <span class="format-badge">CSV</span>
            <span class="format-badge">XLSX</span>
          </div>
          <button class="upload-btn">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
        </div>
        <input type="file" id="priceInput" accept=".csv,.xlsx,.xls">
      </div>
    </div>
  </div>

  <div class="progress-bar" id="progressBar">
    <div class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div class="stats-bar" id="statsBar">
    <div class="stats-grid" style="grid-template-columns: repeat(5,1fr)">
      <div class="stat-item" onclick="filterByView('all')" data-view="all">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –≤ –ø—Ä–∞–π—Å–µ</div>
      </div>
      <div class="stat-item" onclick="filterByView('high')" data-view="high">
        <div class="stat-value" id="statHigh">0</div>
        <div class="stat-label">–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å</div>
      </div>
      <div class="stat-item" onclick="filterByView('new')" data-view="new">
        <div class="stat-value" id="statNew">0</div>
        <div class="stat-label">–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
      </div>
      <div class="stat-item" onclick="filterByView('review')" data-view="review">
        <div class="stat-value" id="statReview">0</div>
        <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
      </div>
      <div class="stat-item" onclick="filterByView('skipped')" data-view="skipped">
        <div class="stat-value" id="statSkipped">0</div>
        <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
      </div>
    </div>
  </div>

  <div class="results-panel" id="resultsPanel">
    <div class="results-header">
      <div class="results-title" id="resultsTitle">üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã</div>
      <div class="results-subtitle" id="resultsSubtitle"></div>
    </div>
    <div class="results-list" id="resultsList">
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
        <div>–ë–∞–∑–∞ (JSON/CSV/XLSX) + –ø—Ä–∞–π—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üîó –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="similarity-info-compact">
        <div class="similarity-percent-compact" id="modalSimilarity">0%</div>
        <div class="similarity-text-compact">–û–±—â–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å</div>
      </div>
      <div class="action-info-compact" id="actionInfoCompact">
        <span id="actionTextCompact"></span>
      </div>
      <div class="product-compact">
        <div class="product-header-compact">
          <span class="product-badge">üìÑ –ù–û–í–´–ô</span>
          <div class="product-barcode-compact" id="modalPriceBarcode"></div>
        </div>
        <div class="product-name-compact" id="modalPriceName"></div>
      </div>
      <div style="text-align:center;color:#34c759;font-size:24px;margin:12px 0;">‚¨á</div>
      <div class="product-compact">
        <div class="product-header-compact">
          <span class="product-badge">üì¶ –ë–ê–ó–ê</span>
          <div class="product-barcode-compact" id="modalMainBarcode"></div>
        </div>
        <div class="product-name-compact" id="modalMainName"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()"></button>
    </div>
  </div>
</div>

<script>
// =============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´ –ò –°–û–°–¢–û–Ø–ù–ò–ï
// =============================================================================
let jsonData = {};
let priceData = [];
let allMatches = [];
let matchResults = [];
let skippedItems = [];
let highMatches = [];
let reviewItems = [];
let changesMap = new Map();
let pendingAction = null;
let currentView = 'high';

const BARCODE_COLS = ['—à—Ç—Ä–∏—Ö–∫–æ–¥','—à—Ç—Ä–∏—Ö-–∫–æ–¥','barcode','–®–ö','—à–∫','–∫–æ–¥','ean','–®—Ç—Ä–∏—Ö–∫–æ–¥'];
const NAME_COLS = ['–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä','–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ø—Ä–æ–¥—É–∫—Ç','–ù–∞–∑–≤–∞–Ω–∏–µ','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'];
const SYNONYM_COLS = ['—Å–∏–Ω–æ–Ω–∏–º—ã','synonyms','—Å–∏–Ω–æ–Ω–∏–º','synonym','–°–∏–Ω–æ–Ω–∏–º—ã'];

const SIMILARITY_THRESHOLD = 42;
const REVIEW_THRESHOLD = 60;
const HIGH_THRESHOLD = 80;

// =============================================================================
// V4.0: –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–õ–û–í–ê–†–¨ –ë–†–ï–ù–î–û–í ‚Äî 150+ –ø–æ–∑–∏—Ü–∏–π
// –ö–∞–∂–¥—ã–π –∫–ª—é—á ‚Äî –ª—é–±–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è ‚Üí –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, lowercase)
// =============================================================================
const BRAND_CANONICAL = {
  // –®–æ–∫–æ–ª–∞–¥ / —Å–ª–∞–¥–æ—Å—Ç–∏
  'milka':'milka','–º–∏–ª–∫–∞':'milka',
  'kitkat':'kitkat','kit kat':'kitkat','kit-kat':'kitkat','–∫–∏—Ç-–∫–∞—Ç':'kitkat','–∫–∏—Ç–∫–∞—Ç':'kitkat',
  'bounty':'bounty','–±–∞—É–Ω—Ç–∏':'bounty',
  'snickers':'snickers','—Å–Ω–∏–∫–µ—Ä—Å':'snickers','—Å–Ω–∏–∫–µ—Ä–∑':'snickers',
  'twix':'twix','—Ç–≤–∏–∫—Å':'twix',
  'mars':'mars','–º–∞—Ä—Å':'mars',
  'raffaello':'raffaello','—Ä–∞—Ñ–∞—ç–ª–ª–æ':'raffaello','—Ä–∞—Ñ–∞—ç–ª–æ':'raffaello','—Ä–∞—Ñ–∞–µ–ª–æ':'raffaello',
  'ferrero':'ferrero','—Ñ–µ—Ä—Ä–µ—Ä–æ':'ferrero',
  'rocher':'rocher','—Ä–æ—à–µ—Ä':'rocher',
  'nutella':'nutella','–Ω—É—Ç–µ–ª–ª–∞':'nutella','–Ω—É—Ç–µ–ª–∞':'nutella',
  'kinder':'kinder','–∫–∏–Ω–¥–µ—Ä':'kinder',
  'toblerone':'toblerone','—Ç–æ–±–ª–µ—Ä–æ–Ω':'toblerone',
  'alenka':'alenka','–∞–ª–µ–Ω–∫–∞':'alenka','–∞–ª—ë–Ω–∫–∞':'alenka',
  'babaevsky':'babaevsky','–±–∞–±–∞–µ–≤—Å–∫–∏–π':'babaevsky',
  'roshen':'roshen','—Ä–æ—à–µ–Ω':'roshen',
  'nesquik':'nesquik','–Ω–µ—Å–∫–≤–∏–∫':'nesquik',
  'merci':'merci','–º–µ—Ä—Å–∏':'merci',
  'ritter':'ritter','ritter sport':'ritter','—Ä–∏—Ç—Ç–µ—Ä':'ritter',
  'lindt':'lindt','–ª–∏–Ω–¥—Ç':'lindt',
  'godiva':'godiva','–≥–æ–¥–∏–≤–∞':'godiva',
  'haribo':'haribo','—Ö–∞—Ä–∏–±–æ':'haribo',
  'trolli':'trolli','—Ç—Ä–æ–ª–ª–∏':'trolli',
  'werther':'werther','–≤–µ—Ä—Ç–µ—Ä':'werther',
  'oreo':'oreo','–æ—Ä–µ–æ':'oreo',
  'mentos':'mentos','–º–µ–Ω—Ç–æ—Å':'mentos',
  'tic tac':'tictac','tic-tac':'tictac','tictac':'tictac','—Ç–∏–∫ —Ç–∞–∫':'tictac',
  'alpen gold':'alpengold','alpengold':'alpengold','alpen-gold':'alpengold','–∞–ª—å–ø–µ–Ω–≥–æ–ª–¥':'alpengold',
  'rot front':'rotfront','—Ä–æ—Ç —Ñ—Ä–æ–Ω—Ç':'rotfront','—Ä–æ—Ç—Ñ—Ä–æ–Ω—Ç':'rotfront',
  // –ñ–µ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∑–∏–Ω–∫–∞
  'orbit':'orbit','–æ—Ä–±–∏—Ç':'orbit',
  'dirol':'dirol','–¥–∏—Ä–æ–ª':'dirol',
  'wrigley':'wrigley','—Ä–∏–≥–ª–∏':'wrigley',
  'extra':'extra','—ç–∫—Å—Ç—Ä–∞':'extra',
  'halls':'halls','—Ö–æ–ª–ª—Å':'halls',
  // –ß–∏–ø—Å—ã / —Å–Ω–µ–∫–∏
  "lay's":'lays','lays':'lays','–ª—ç–π—Å':'lays','–ª–µ–π—Å':'lays',
  'cheetos':'cheetos','—á–∏—Ç–æ—Å':'cheetos',
  'pringles':'pringles','–ø—Ä–∏–Ω–≥–ª—Å':'pringles',
  'doritos':'doritos','–¥–æ—Ä–∏—Ç–æ—Å':'doritos',
  'ruffles':'ruffles','—Ä–∞—Ñ—Ñ–ª—Å':'ruffles',
  'estrella':'estrella',
  '—Ñ—Äitos':'fritos','fritos':'fritos',
  // –ù–∞–ø–∏—Ç–∫–∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏
  'red bull':'redbull','redbull':'redbull','—Ä–µ–¥–±—É–ª–ª':'redbull','—Ä–µ–¥ –±—É–ª–ª':'redbull',
  'monster':'monster','–º–æ–Ω—Å—Ç—Ä':'monster',
  'burn':'burn','–±—ë—Ä–Ω':'burn',
  'rockstar':'rockstar','—Ä–æ–∫—Å—Ç–∞—Ä':'rockstar',
  // –ì–∞–∑–∏—Ä–æ–≤–∫–∞
  'coca cola':'cocacola','coca-cola':'cocacola','cocacola':'cocacola',
  '–∫–æ–∫–∞ –∫–æ–ª–∞':'cocacola','–∫–æ–∫–∞-–∫–æ–ª–∞':'cocacola',
  'pepsi':'pepsi','–ø–µ–ø—Å–∏':'pepsi',
  'sprite':'sprite','—Å–ø—Ä–∞–π—Ç':'sprite',
  'fanta':'fanta','—Ñ–∞–Ω—Ç–∞':'fanta',
  '7up':'7up','7 up':'7up',
  'mirinda':'mirinda','–º–∏—Ä–∏–Ω–¥–∞':'mirinda',
  'schweppes':'schweppes','—à–≤–µ–ø—Å':'schweppes',
  'dr pepper':'drpepper','dr.pepper':'drpepper',
  // –ß–∞–π
  'lipton':'lipton','–ª–∏–ø—Ç–æ–Ω':'lipton',
  'nestea':'nestea','–Ω–µ—Å—Ç–∏':'nestea',
  'greenfield':'greenfield','–≥—Ä–∏–Ω—Ñ–∏–ª–¥':'greenfield',
  'richard':'richard','—Ä–∏—á–∞—Ä–¥':'richard',
  'ahmad':'ahmad','–∞—Ö–º–∞–¥':'ahmad',
  'tess':'tess','—Ç–µ—Å—Å':'tess',
  'curtis':'curtis','–∫—ë—Ä—Ç–∏—Å':'curtis',
  'dilmah':'dilmah','–¥–∏–ª–º–∞':'dilmah',
  // –í–æ–¥–∞ / —Å–æ–∫
  'evian':'evian','—ç–≤–∏–∞–Ω':'evian',
  'perrier':'perrier','–ø–µ—Ä—å–µ':'perrier',
  'vittel':'vittel','–≤–∏—Ç—Ç–µ–ª—å':'vittel',
  'bonaqua':'bonaqua','–±–æ–Ω–∞–∫–≤–∞':'bonaqua',
  'aqua minerale':'aquaminerale','–∞–∫–≤–∞ –º–∏–Ω–µ—Ä–∞–ª–µ':'aquaminerale',
  'j7':'j7',
  '–¥–æ–±—Ä—ã–π':'dobry','dobry':'dobry',
  'rich':'rich','—Ä–∏—á':'rich',
  '—è':'ya',
  // –ö–æ—Ñ–µ
  'nescafe':'nescafe','nescaf√©':'nescafe','–Ω–µ—Å–∫–∞—Ñ–µ':'nescafe','–Ω—ç—Å–∫–∞—Ñ–µ':'nescafe',
  'jacobs':'jacobs','—è–∫–æ–±—Å':'jacobs','—è–∫–æ–±–∑':'jacobs','—è–∫–æ–±—Å':'jacobs',
  'lavazza':'lavazza','–ª–∞–≤–∞—Ü—Ü–∞':'lavazza','–ª–∞–≤–∞–∑–∞':'lavazza',
  'illy':'illy','–∏–ª–ª–∏':'illy',
  'tchibo':'tchibo','—á–∏–±–æ':'tchibo',
  'carte noire':'cartenoire','–∫–∞—Ä—Ç –Ω—É–∞—Ä':'cartenoire',
  'maxwell house':'maxwellhouse',
  'jardin':'jardin','–∂–∞—Ä–¥–∏–Ω':'jardin',
  'grandos':'grandos',
  'ambassador':'ambassador','–∞–º–±–∞—Å—Å–∞–¥–æ—Ä':'ambassador',
  'davidoff':'davidoff','–¥–∞–≤—ã–¥–æ–≤':'davidoff',
  'black card':'blackcard',
  // –ú–æ–ª–æ—á–∫–∞
  'danone':'danone','–¥–∞–Ω–æ–Ω':'danone','–¥–∞–Ω–æ–Ω–µ':'danone',
  'activia':'activia','–∞–∫—Ç–∏–≤–∏–∞':'activia','–∞–∫—Ç–∏–≤–∏—è':'activia',
  'actimel':'actimel','–∞–∫—Ç–∏–º–µ–ª—å':'actimel',
  'ehrmann':'ehrmann','—ç—Ä–º–∞–Ω–Ω':'ehrmann',
  'hochland':'hochland','—Ö–æ—Ö–ª–∞–Ω–¥':'hochland',
  "pr√©sident":'president','president':'president','–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç':'president',
  'valio':'valio','–≤–∞–ª–∏–æ':'valio',
  'anchor':'anchor','–∞–Ω–∫–æ—Ä':'anchor',
  'arla':'arla','–∞—Ä–ª–∞':'arla',
  'simple':'simple','—Å–∏–º–ø–ª':'simple',
  // –ë–∞–∫–∞–ª–µ—è / —Å–æ—É—Å—ã
  'heinz':'heinz','—Ö–∞–π–Ω—Ü':'heinz',
  "kellogg's":'kelloggs','kelloggs':'kelloggs','–∫–µ–ª–ª–æ–≥—Å':'kelloggs',
  'nestl√©':'nestle','nestle':'nestle','–Ω–µ—Å—Ç–ª–µ':'nestle',
  'knorr':'knorr','–∫–Ω–æ—Ä—Ä':'knorr',
  'maggi':'maggi','–º–∞–≥–≥–∏':'maggi',
  'bonduelle':'bonduelle','–±–æ–Ω–¥—é—ç–ª—å':'bonduelle',
  "hellmann's":'hellmanns','hellmanns':'hellmanns',
  'tabasco':'tabasco','—Ç–∞–±–∞—Å–∫–æ':'tabasco',
  'worcestershire':'worcestershire',
  'makfa':'makfa','–º–∞–∫—Ñ–∞':'makfa',
  'barilla':'barilla','–±–∞—Ä–∏–ª–∞':'barilla','–±–∞—Ä–∏–ª–ª–∞':'barilla',
  'de cecco':'dececco',
  // –ú—é—Å–ª–∏ / –∑–∞–≤—Ç—Ä–∞–∫–∏
  'fitness':'fitness',
  'cheerios':'cheerios',
  'granola':'granola',
};

// =============================================================================
// V4.0: –î–ï–°–ö–†–ò–ü–¢–û–†–´ ‚Äî —Ç—Ä–∞–Ω—Å–ª–∏—Ç —Ä—É—Å ‚Üí –ª–∞—Ç (–¥–ª—è –∫—Ä–æ—Å—Å-—Å–∫—Ä–∏–ø—Ç–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤)
// =============================================================================
const DESCRIPTOR_MAP = {
  '–≥–æ–ª–¥':'gold','—Å–∏–ª–≤–µ—Ä':'silver','–±–ª—ç–∫':'black','–±–ª–µ–∫':'black',
  '–≤–∞–π—Ç':'white','–≥—Ä–∏–Ω':'green','–±–ª—é':'blue',
  '–∫–ª–∞—Å—Å–∏–∫':'classic','–∫–ª–∞—Å–∏–∫':'classic',
  '–æ—Ä–∏–¥–∂–∏–Ω–∞–ª':'original','–æ—Ä–∏–¥–∂–Ω–ª':'original',
  '–ø—Ä–µ–º–∏—É–º':'premium','—É–ª—å—Ç—Ä–∞':'ultra','–ø—Ä–æ':'pro',
  '–º–æ–Ω–∞—Ä—Ö':'monarch',
  '–ª–∞–π—Ç':'light','–ª–∞–π—Ç—Å':'lights',
  '–º–∞–ª–∏–Ω–∞':'raspberry','–∫–ª—É–±–Ω–∏–∫–∞':'strawberry',
  '–≤–∞–Ω–∏–ª—å':'vanilla','–ª–∏–º–æ–Ω':'lemon',
  '–∞—Ä–∞–±–∏–∫–∞':'arabica','—Ä–æ–±—É—Å—Ç–∞':'robusta',
  '—ç—Å–ø—Ä–µ—Å—Å–æ':'espresso','–∫–∞–ø—É—á–∏–Ω–æ':'cappuccino',
  '–º–æ–ª–æ—á–Ω—ã–π':'milk','–º–æ–ª–æ–∫–æ':'milk',
  '—Å–ª–∏–≤–æ—á–Ω—ã–π':'cream','—Å–ª–∏–≤–∫–∏':'cream',
  '—á–µ—Ä–Ω—ã–π':'black','—á—ë—Ä–Ω—ã–π':'black',
  '–±–µ–ª—ã–π':'white','–∑–µ–ª–µ–Ω—ã–π':'green','–∑–µ–ª—ë–Ω—ã–π':'green',
};

// –°—Ç—Ä–æ–∏–º –±—ã—Å—Ç—Ä—ã–π lookup: –≤–∞—Ä–∏–∞–Ω—Ç ‚Üí –±–∞–∑–∞ (–¥–ª—è extractBrand)
const SYNONYM_TO_BASE = {};
for (const [variant, base] of Object.entries(BRAND_CANONICAL)) {
  SYNONYM_TO_BASE[variant.toLowerCase()] = base;
}

// =============================================================================
// V4.1: –†–ï–ë–†–ï–ù–î–ò–ù–ì–ò –í –†–§ –ø–æ—Å–ª–µ 2022 + —Ç–∏–ø–∏—á–Ω—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
// –û–±–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Üí –æ–¥–∏–Ω –∫–∞–Ω–æ–Ω, –ø–æ—ç—Ç–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º –∏—Ö –æ—Ç–æ–∂–¥–µ—Å—Ç–≤–∏—Ç
// =============================================================================
const REBRANDING_MAP = {
  // Nesquik ‚Üí –•—Ä—É—Ç–∫–∞ (Nestl√©, 2022‚Äî2023)
  '–Ω–µ—Å–∫–≤–∏–∫':'nesquik',  'nesquik':'nesquik',  '–Ω—ç—Å–∫–≤–∏–∫':'nesquik',
  '—Ö—Ä—É—Ç–∫–∞':'nesquik',   'hrutka':'nesquik',

  // Lay's ‚Üí –ó–∞—Ö—Ä—É—Å—Ç–∏–º (PepsiCo ‚Üí –û–û–û ¬´–§—Ä–∏–∑-–§—Ä–∏¬ª, 2023)
  "lay's":'lays', '–ª—ç–π—Å':'lays', '–ª–µ–π—Å':'lays', 'lays':'lays',
  '–∑–∞—Ö—Ä—É—Å—Ç–∏–º':'lays', '–∑–∞—Ö—Ä—É—Å—Ç–∏–º–∫–∞':'lays',

  // Alpen Gold ‚Äî –æ–ø–µ—á–∞—Ç–∫–∏ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (Mondelez –æ—Å—Ç–∞—ë—Ç—Å—è)
  'alpen gold':'alpengold', 'alpengold':'alpengold', 'alpen-gold':'alpengold',
  '–∞–ª—å–ø–µ–Ω–≥–æ–ª–¥':'alpengold', '–∞–ª—å–ø–µ–Ω –≥–æ–ª–¥':'alpengold', '–∞–ª—å–ø–µ–Ω –≥–æ–ª—å–¥':'alpengold',
  '–∞–ª–ø–µ–Ω –≥–æ–ª–¥':'alpengold', '–∞–ª–ø–µ–Ω –≥–æ–ª—å–¥':'alpengold', '–∞–ª–ø–µ–Ω–≥–æ–ª–¥':'alpengold',
  'ag':'alpengold',

  // KitKat ‚Äî –æ–ø–µ—á–∞—Ç–∫–∏/—Å–ª–∏—Ç–Ω–æ
  'kitkat':'kitkat', 'kit kat':'kitkat', '–∫–∏—Ç –∫–∞—Ç':'kitkat', '–∫–∏—Ç–∫–∞—Ç':'kitkat',
  '–∫–∏—Ç-–∫–∞—Ç':'kitkat', 'kit-kat':'kitkat', '–∫–∫':'kitkat',

  // Nescafe ‚Äî –æ–ø–µ—á–∞—Ç–∫–∏/—Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
  'nescafe':'nescafe', 'nescaf√©':'nescafe', '–Ω–µ—Å–∫–∞—Ñ–µ':'nescafe',
  '–Ω—ç—Å–∫–∞—Ñ–µ':'nescafe', 'neskafe':'nescafe', '–Ω–∫':'nescafe',

  // Jacobs ‚Äî –æ–ø–µ—á–∞—Ç–∫–∏
  'jacobs':'jacobs', '—è–∫–æ–±—Å':'jacobs', '—è–∫–æ–±–∑':'jacobs', '–¥–∂–∞–∫–æ–±—Å':'jacobs',
  'jakobs':'jacobs',

  // –ü—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ (–º–æ–ª–æ—á–Ω–∞—è –ª–∏–Ω–µ–π–∫–∞ Danone –ø–æ–¥ —Ä–æ—Å. —Å—É–±–±—Ä–µ–Ω–¥–æ–º)
  '–¥–∞–Ω–æ–Ω':'danone', 'danone':'danone', '–¥–∞–Ω–æ–Ω–µ':'danone',
  '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ':'danone',

  // Orbit / Dirol –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç, –Ω–æ —á–∞—Å—Ç–æ –ø–∏—à—É—Ç –ø–æ-—Ä–∞–∑–Ω–æ–º—É
  'orbit':'orbit', '–æ—Ä–±–∏—Ç':'orbit', '—ã—Ä–±–∏—Ç':'orbit',
  'dirol':'dirol', '–¥–∏—Ä–æ–ª':'dirol', '–¥–∏—Ä–æ–ª—å':'dirol',

  // Red Bull ‚Äî —Å–ª–∏—Ç–Ω–æ/—Ä–∞–∑–¥–µ–ª—å–Ω–æ
  'red bull':'redbull', 'redbull':'redbull', '—Ä–µ–¥ –±—É–ª–ª':'redbull',
  '—Ä–µ–¥–±—É–ª–ª':'redbull', 'redbul':'redbull', '—Ä–µ–¥ –±—É–ª':'redbull',

  // Raffaello ‚Äî —á–∞—Å—Ç—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏
  'raffaello':'raffaello', '—Ä–∞—Ñ–∞—ç–ª–ª–æ':'raffaello',
  '—Ä–∞—Ñ–∞—ç–ª–æ':'raffaello', '—Ä–∞—Ñ–∞—ç–ª—å':'raffaello', '—Ä–∞—Ñ–∞–µ–ª–æ':'raffaello',

  // Milka
  'milka':'milka', '–º–∏–ª–∫–∞':'milka', '–º–∏–ª—å–∫–æ':'milka',

  // Bounty
  'bounty':'bounty', '–±–∞—É–Ω—Ç–∏':'bounty', '–±a—É–Ω—Ç–∏':'bounty',
};
// –ú—ë—Ä–¥–∂–∏–º –≤ –æ–±—â–∏–π lookup –±—Ä–µ–Ω–¥–æ–≤
for (const [k,v] of Object.entries(REBRANDING_MAP))
  SYNONYM_TO_BASE[k.toLowerCase()] = v;

// =============================================================================
// V4.0: –í–ö–£–°–´ –ò –£–ü–ê–ö–û–í–ö–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
// =============================================================================
const FLAVOR_SYNONYMS = {
  'chicken':    ['–∫—É—Ä–∏—Ü–∞','–∫—É—Ä–∏–Ω—ã–π','–∫—É—Ä–∏–Ω','chicken','chiken'],
  'beef':       ['–≥–æ–≤—è–¥–∏–Ω–∞','–≥–æ–≤—è–∂–∏–π','beef'],
  'vanilla':    ['–≤–∞–Ω–∏–ª—å','vanilla','–≤–∞–Ω–∏–ª—å–Ω—ã–π','vanila'],
  'chocolate':  ['—à–æ–∫–æ–ª–∞–¥','chocolate','—à–æ–∫–æ–ª–∞–¥–Ω—ã–π','choco','chokolate'],
  'mint':       ['–º—è—Ç–∞','mint','–º—è—Ç–Ω—ã–π'],
  'strawberry': ['–∫–ª—É–±–Ω–∏–∫–∞','–∫–ª—É–±–Ω–∏—á–Ω—ã–π','strawberry','strawbery'],
  'raspberry':  ['–º–∞–ª–∏–Ω–∞','–º–∞–ª–∏–Ω–æ–≤—ã–π','raspberry'],
  'blueberry':  ['—á–µ—Ä–Ω–∏–∫–∞','—á–µ—Ä–Ω–∏—á–Ω—ã–π','blueberry'],
  'cherry':     ['–≤–∏—à–Ω—è','–≤–∏—à–Ω–µ–≤—ã–π','cherry'],
  'lemon':      ['–ª–∏–º–æ–Ω','–ª–∏–º–æ–Ω–Ω—ã–π','lemon'],
  'orange':     ['–∞–ø–µ–ª—å—Å–∏–Ω','–∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π','orange'],
  'peach':      ['–ø–µ—Ä—Å–∏–∫','–ø–µ—Ä—Å–∏–∫–æ–≤—ã–π','peach'],
  'mango':      ['–º–∞–Ω–≥–æ','mango'],
  'caramel':    ['–∫–∞—Ä–∞–º–µ–ª—å','–∫–∞—Ä–∞–º–µ–ª—å–Ω—ã–π','caramel','karamel'],
  'hazelnut':   ['–æ—Ä–µ—Ö','–æ—Ä–µ—Ö–æ–≤—ã–π','—Ñ—É–Ω–¥—É–∫','hazelnut'],
  'almond':     ['–º–∏–Ω–¥–∞–ª—å','–º–∏–Ω–¥–∞–ª—å–Ω—ã–π','almond'],
  'cream':      ['—Å–ª–∏–≤–æ—á–Ω—ã–π','cream','—Å–ª–∏–≤–∫–∏','–∫—Ä–µ–º'],
  'mocha':      ['–º–æ–∫–∫–æ','–º–æ–∫–∞','mocha'],
  'espresso':   ['—ç—Å–ø—Ä–µ—Å—Å–æ','espresso'],
  'cappuccino': ['–∫–∞–ø—É—á–∏–Ω–æ','cappuccino','–∫–∞–ø–ø—É—á–∏–Ω–æ'],
  'latte':      ['–ª–∞—Ç—Ç–µ','latte'],
  'americano':  ['–∞–º–µ—Ä–∏–∫–∞–Ω–æ','americano'],
  'menthol':    ['–º–µ–Ω—Ç–æ–ª','menthol'],
  'watermelon': ['–∞—Ä–±—É–∑','watermelon'],
  'apple':      ['—è–±–ª–æ–∫–æ','—è–±–ª–æ—á–Ω—ã–π','apple'],
  'grape':      ['–≤–∏–Ω–æ–≥—Ä–∞–¥','–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π','grape'],
  'coconut':    ['–∫–æ–∫–æ—Å','–∫–æ–∫–æ—Å–æ–≤—ã–π','coconut'],
  'honey':      ['–º—ë–¥','–º–µ–¥','honey'],
};

const FLAVOR_TO_BASE = {};
for (const [base, syns] of Object.entries(FLAVOR_SYNONYMS))
  for (const s of syns) FLAVOR_TO_BASE[s.toLowerCase()] = base;

// V4.1: PACKAGING ‚Äî 20+ —Ç–∏–ø–æ–≤, greedy longest-first
// –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞: –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Üí –µ–¥–∏–Ω—ã–π –∫–∞–Ω–æ–Ω
const PACKAGING_GROUPS = [
  { canon:'–º—è–≥–∫–∞—è', v:['–º—è–≥–∫–∞—è —É–ø–∞–∫–æ–≤–∫–∞','soft pack','soft pouch','–º—è–≥–∫ —É–ø','–º—è–≥–∫.—É–ø','–º/—É','–º.—É','–º.—É.','mu','–º—É','–ø–∞–∫–µ—Ç','–ø–∞–∫–µ—Ç–∏–∫','–ø–∞—á–∫–∞','—Å–∞—à–µ','sachet','pouch','–º—è–≥'] },
  { canon:'—Å—Ç–µ–∫–ª–æ', v:['—Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –±—É—Ç—ã–ª–∫–∞','—Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –±–∞–Ω–∫–∞','glass bottle','glass jar','—Å—Ç–µ–∫–ª–æ','—Å—Ç/–±','—Å/–±','—Å—Ç–±','—Å—Ç–µ–∫','—Å—Ç–µ–∫–ª','glass'] },
  { canon:'–∂–±',     v:['–∂–µ—Å—Ç—è–Ω–∞—è –±–∞–Ω–∫–∞','–∞–ª—é–º–∏–Ω–∏–µ–≤–∞—è –±–∞–Ω–∫–∞','–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –±–∞–Ω–∫–∞','aluminum can','tin can','–∂–±','–∂/–±','–∂.–±','–∂–µ—Å—Ç—å','–∞–ª—é–º–∏–Ω–∏–π','–º–µ—Ç–∞–ª–ª','–±–∞–Ω–∫–∞ –∞–ª—é–º','can','tin','–∞–ª—é–º'] },
  { canon:'–ø—ç—Ç',    v:['–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è –±—É—Ç—ã–ª–∫–∞','–ø—ç—Ç –±—É—Ç—ã–ª–∫–∞','pet bottle','plastic bottle','–ø—ç—Ç','–ø–µ—Ç','–ø–µ—Ç.','–ø–ª–∞—Å—Ç–∏–∫','–ø–ª–∞—Å—Ç','–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è','pet','plastic'] },
  { canon:'—Ç–±',     v:['—Ç–µ—Ç—Ä–∞ –ø–∞–∫','tetra pak','tetra pack','—Ç–µ—Ç—Ä–∞-–ø–∞–∫','tetrapak','—Ç–µ—Ç—Ä–∞–ø–∞–∫','—Ç–±','—Ç/–±','—Ç.–±','—Ç–µ—Ç—Ä–∞','tetra'] },
  { canon:'–¥–æ—É–ø–∞–∫', v:['–¥–æ–π –ø–∞–∫','–¥–æ—É –ø–∞–∫','doy pack','doy-pack','stand up pouch','–¥–æ—É–ø–∞–∫','–¥–æ—É-–ø–∞–∫','–¥–æ–π–ø–∞–∫','–¥–æ–π-–ø–∞–∫'] },
  { canon:'–∫–∞—Ä—Ç–æ–Ω', v:['–∫–∞—Ä—Ç–æ–Ω–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞','–∫–∞—Ä—Ç–æ–Ω–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞','cardboard box','–∫–∞—Ä—Ç–æ–Ω','–∫–æ—Ä–æ–±–∫–∞','–∫–∞—Ä—Ç','carton'] },
  { canon:'–≤–µ–¥—Ä–æ',  v:['–ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–µ –≤–µ–¥—Ä–æ','–≤–µ–¥—Ä–æ –ø–ª–∞—Å—Ç–∏–∫','–≤–µ–¥—Ä–æ','–≤–µ–¥','bucket'] },
  { canon:'—Ç—É–±–∞',   v:['—Ç—É–±–∞','—Ç—é–±–∞','tube'] },
  { canon:'—Å–ø—Ä–µ–π',  v:['–∞—ç—Ä–æ–∑–æ–ª—å','—Å–ø—Ä–µ–π','spray','aerosol'] },
  { canon:'—Ñ–ª–∞–∫–æ–Ω', v:['—Ñ–ª–∞–∫–æ–Ω','—Ñ–ª–∞–∫'] },
  { canon:'–≤–∞–∫—É—É–º', v:['–≤–∞–∫—É—É–º','–≤–∞–∫','vacuum'] },
  { canon:'–∑–∏–ø',    v:['–∑–∏–ø –ø–∞–∫–µ—Ç','zip –ø–∞–∫–µ—Ç','zip-lock','–∑–∏–ø–ª–æ–∫','–∑–∏–ø–æ–∫'] },
];
// Flat map: variant‚Üícanon, keys sorted longest-first for greedy match
const PACKAGING_NORM = {};
for (const { canon, v } of PACKAGING_GROUPS)
  for (const x of v) PACKAGING_NORM[x] = canon;
const PACKAGING_KEYS_SORTED = Object.keys(PACKAGING_NORM).sort((a,b) => b.length - a.length);

const IGNORE_PATTERNS = [
  /\([^)]*\)/g,
  /\d+—Ö\d+/g,
  /!!!.*?!!!/g,
  /\b–∞–∫—Ü–∏—è\b/gi,
  /\bnew\b/gi,
];

const STOP_WORDS = new Set([
  '–∏','–≤','—Å','–¥–ª—è','–Ω–∞','–æ—Ç','–ø–æ','–∏–∑','–∫','–∑–∞','–æ','–æ–±','–ø—Ä–∏','–¥–æ','–ø–æ–¥',
  '–∏–ª–∏','–Ω–µ','—Ç–æ','—ç—Ç–æ','–∂–µ','–∞','–Ω–æ','–∫–∞–∫','—Ç–∞–∫','–≤—Å–µ','–±','—à—Ç','—É–ø','–∞—Ä—Ç','–∫–æ–¥',
  'the','a','an','of','for','with','and','in','to','from','by','at',
]);

// =============================================================================
// V4.0: –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ï–î–ò–ù–ò–¶ –ò–ó–ú–ï–†–ï–ù–ò–Ø
// =============================================================================
const UNIT_PATTERNS = [
  { re: /(\d+(?:[.,]\d+)?)\s*–∫–≥/gi,                     factor: 1000 },
  { re: /(\d+(?:[.,]\d+)?)\s*kg/gi,                     factor: 1000 },
  { re: /(\d+(?:[.,]\d+)?)\s*–≥—Ä?\.?(?=[^–∞-—èa-z]|$)/gi, factor: 1    },
  { re: /(\d+(?:[.,]\d+)?)\s*g(?:rs?)?\.?(?=[^a-z]|$)/gi, factor: 1 },
  { re: /(\d+(?:[.,]\d+)?)\s*–º–ª/gi,                     factor: 1    },
  { re: /(\d+(?:[.,]\d+)?)\s*ml/gi,                     factor: 1    },
  { re: /(\d+(?:[.,]\d+)?)\s*–ª\b/gi,                    factor: 1000 },
  { re: /(\d+(?:[.,]\d+)?)\s*l(?:it(?:er|re)?s?)?\b/gi, factor: 1000 },
  { re: /(\d+(?:[.,]\d+)?)\s*oz\b/gi,                   factor: 28.35 },
  { re: /(\d+(?:[.,]\d+)?)\s*lb\b/gi,                   factor: 453.6 },
];

function normalizeUnits(text) {
  let result = text;
  for (const { re, factor } of UNIT_PATTERNS) {
    re.lastIndex = 0;
    result = result.replace(re, (_, num) => {
      const val = parseFloat(num.replace(',', '.')) * factor;
      return (val === Math.floor(val) ? Math.floor(val) : val.toFixed(1)) + '–≥';
    });
  }
  return result;
}

// =============================================================================
// V4.0: –§–û–ù–ï–¢–ò–ö–ê ‚Äî Russian –∏ Latin
// =============================================================================
const RU_PHONETIC = [
  [/\b—ç/g, '–µ'], [/—ç/g, '–µ'],
  [/—Ñ/g, '–≤'],
  [/–∑\b/g, '—Å'],
  [/[—Ç–¥]—Å/g, '—Ü'],
  [/–¥–∂/g, '–∂'],
  [/([–∞-—è—ë])\1+/g, '$1'],
  [/[—ã–∏]–π\b/g, '–∏'],
];
const LAT_PHONETIC = [
  [/ph/g, 'f'],
  [/ck\b/g, 'k'],
  [/([a-z])\1+/g, '$1'],
  [/ae/g, 'e'],
];

function phoneticKey(word) {
  let t = word.toLowerCase();
  if (/[–∞-—è—ë]/.test(t)) {
    for (const [pat, repl] of RU_PHONETIC) t = t.replace(pat, repl);
  } else {
    for (const [pat, repl] of LAT_PHONETIC) t = t.replace(pat, repl);
  }
  return t;
}

// =============================================================================
// V4.0: –ö–ê–ù–û–ù–ò–ó–ê–¶–ò–Ø –ë–†–ï–ù–î–û–í
// =============================================================================
function canonicalizeBrands(text) {
  const tokens = text.split(' ');
  const result = [];
  let i = 0;
  while (i < tokens.length) {
    // –°–Ω–∞—á–∞–ª–∞ –±–∏–≥—Ä–∞–º–º–∞
    if (i + 1 < tokens.length) {
      const bigram = tokens[i] + ' ' + tokens[i + 1];
      const canon = BRAND_CANONICAL[bigram];
      if (canon) { result.push(canon); i += 2; continue; }
    }
    const canon = BRAND_CANONICAL[tokens[i]];
    if (canon) {
      result.push(canon);
    } else {
      result.push(DESCRIPTOR_MAP[tokens[i]] || tokens[i]);
    }
    i++;
  }
  return result.join(' ');
}

// =============================================================================
// V4.0: TOKEN SET ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –Ω–µ –≤–∞–∂–µ–Ω)
// =============================================================================
function tokenSort(text) {
  return text.split(' ').filter(Boolean).sort().join(' ');
}

// =============================================================================
// –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê (v4: —Å –¥–µ—Ñ–∏—Å–∞–º–∏, –µ–¥–∏–Ω–∏—Ü–∞–º–∏, –±—Ä–µ–Ω–¥–∞–º–∏, —Ñ–æ–Ω–µ—Ç–∏–∫–æ–π)
// =============================================================================
function cleanText(text) {
  let cleaned = String(text || '');
  for (const p of IGNORE_PATTERNS) cleaned = cleaned.replace(p, ' ');
  return cleaned.trim();
}

/**
 * –ü–æ–ª–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è.
 * @param {string} text
 * @param {{ phonetic?: boolean, sorted?: boolean }} opts
 */
function normalizeText(text, opts = {}) {
  let t = cleanText(text);
  // V4: –¥–µ—Ñ–∏—Å—ã ‚Üí –ø—Ä–æ–±–µ–ª (kit-kat ‚Üí kit kat ‚Üí –ø–æ—Å–ª–µ –∫–∞–Ω–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Üí kitkat)
  t = t.replace(/[-‚Äì‚Äî]/g, ' ');
  // V4: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü
  t = normalizeUnits(t);
  t = t.toLowerCase().replace(/—ë/g, '–µ');
  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã
  t = t.replace(/[^–∞-—èa-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
  // V4: –∫–∞–Ω–æ–Ω–∏–∑–∞—Ü–∏—è –±—Ä–µ–Ω–¥–æ–≤
  t = canonicalizeBrands(t);
  // V4: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–æ–Ω–µ—Ç–∏–∫–∞
  if (opts.phonetic) {
    t = t.split(' ').map(phoneticKey).join(' ');
  }
  // V4: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
  if (opts.sorted) {
    t = tokenSort(t);
  }
  return t;
}

// =============================================================================
// –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø (–¥–ª—è –∫—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
// =============================================================================
const RU_TO_EN = {
  '–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z',
  '–∏':'i','–π':'j','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r',
  '—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'ts','—á':'ch','—à':'sh','—â':'sch',
  '—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'
};

function toTranslit(str) {
  return str.toLowerCase().split('').map(c => RU_TO_EN[c] !== undefined ? RU_TO_EN[c] : c).join('');
}

// =============================================================================
// –°–¢–û–ü-–°–õ–û–í–ê –ò –¢–û–ö–ï–ù–´
// =============================================================================
function getSignificantTokens(text) {
  return normalizeText(text).split(' ').filter(w => w.length > 1 && !STOP_WORDS.has(w));
}

function crossLangSimilarity(tok1, tok2) {
  if (tok1 === tok2) return 1;
  const t1 = toTranslit(tok1);
  const t2 = toTranslit(tok2);
  if (t1 === t2) return 1;
  return jaroWinkler(t1, t2);
}

function extractNumbers(text) {
  const matches = normalizeText(text).match(/\d+(?:\.\d+)?/g) || [];
  return matches.map(Number);
}

// =============================================================================
// –ê–õ–ì–û–†–ò–¢–ú–´ –°–•–û–ñ–ï–°–¢–ò
// =============================================================================
function getTrigrams(str) {
  const s = '  ' + str + '  ';
  const trigrams = new Set();
  for (let i = 0; i < s.length - 2; i++) trigrams.add(s.slice(i, i + 3));
  return trigrams;
}

function trigramSimilarity(a, b) {
  if (!a || !b) return 0;
  const ta = getTrigrams(a);
  const tb = getTrigrams(b);
  let common = 0;
  for (const t of ta) if (tb.has(t)) common++;
  return (2 * common) / (ta.size + tb.size);
}

function jaroWinkler(s1, s2) {
  if (s1 === s2) return 1;
  const len1 = s1.length, len2 = s2.length;
  if (!len1 || !len2) return 0;
  const matchDist = Math.max(Math.floor(Math.max(len1, len2) / 2) - 1, 0);
  const s1Matches = new Array(len1).fill(false);
  const s2Matches = new Array(len2).fill(false);
  let matches = 0, transpositions = 0;
  for (let i = 0; i < len1; i++) {
    const start = Math.max(0, i - matchDist);
    const end = Math.min(i + matchDist + 1, len2);
    for (let j = start; j < end; j++) {
      if (s2Matches[j] || s1[i] !== s2[j]) continue;
      s1Matches[i] = s2Matches[j] = true;
      matches++;
      break;
    }
  }
  if (!matches) return 0;
  let k = 0;
  for (let i = 0; i < len1; i++) {
    if (!s1Matches[i]) continue;
    while (!s2Matches[k]) k++;
    if (s1[i] !== s2[k]) transpositions++;
    k++;
  }
  const jaro = (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
  let prefix = 0;
  for (let i = 0; i < Math.min(4, len1, len2); i++) {
    if (s1[i] === s2[i]) prefix++; else break;
  }
  return jaro + prefix * 0.1 * (1 - jaro);
}

// =============================================================================
// –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –í–ï–° / –í–ö–£–° / –ë–†–ï–ù–î / –£–ü–ê–ö–û–í–ö–ê
// =============================================================================
function extractWeight(text) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –µ–¥–∏–Ω–∏—Ü
  const normalized = normalizeUnits(String(text).toLowerCase().replace(/,/g, '.'));
  const m = normalized.match(/(\d+(?:\.\d+)?)\s*–≥\b/);
  if (m) return { value: parseFloat(m[1]), unit: '–≥' };
  const m2 = normalized.match(/(\d+(?:\.\d+)?)\s*–º–ª\b/);
  if (m2) return { value: parseFloat(m2[1]), unit: '–º–ª' };
  return null;
}

function extractBrand(text) {
  // Check via normalizeText (canonical) AND raw lowercase (catches variants with special chars)
  for (const norm of [normalizeText(text), String(text||'').toLowerCase().replace(/[-‚Äì‚Äî]/g,' ').replace(/\s+/g,' ').trim()]) {
    const words = norm.split(' ').filter(Boolean);
    // Bigrams first
    for (let i = 0; i < words.length - 1; i++) {
      const two = words[i] + ' ' + words[i + 1];
      if (SYNONYM_TO_BASE[two]) return SYNONYM_TO_BASE[two];
    }
    // Single tokens
    for (const word of words) {
      if (SYNONYM_TO_BASE[word]) return SYNONYM_TO_BASE[word];
    }
  }
  return null;
}

function extractFlavors(text) {
  const norm = normalizeText(text);
  const result = new Set();
  for (const word of norm.split(' ')) {
    if (FLAVOR_TO_BASE[word]) result.add(FLAVOR_TO_BASE[word]);
  }
  return result;
}

function extractPackaging(text) {
  // V4.1: greedy longest-first match
  // Check TWO forms: raw-lowercased (preserves / . –¥–ª—è –∫–ª—é—á–µ–π —Ç–∏–ø–∞ –º/—É, —Å—Ç/–±)
  // –∏ fully-normalised (–¥–ª—è –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã—Ö —Ç–∏–ø–∞ "–º—è–≥–∫–∞—è —É–ø–∞–∫–æ–≤–∫–∞")
  const raw  = String(text||'').toLowerCase().replace(/[-‚Äì‚Äî]/g,' ').replace(/\s+/g,' ').trim();
  const norm = normalizeText(text);
  for (const key of PACKAGING_KEYS_SORTED) {
    if (raw.includes(key) || norm.includes(key)) return PACKAGING_NORM[key];
  }
  return null;
}

// =============================================================================
// V4.0: –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–†–ê–í–ù–ï–ù–ò–Ø
//   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Token Set Ratio + Phonetic –Ω–∞ –æ–±–æ–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
// =============================================================================
function calculateSimilarity(text1, text2) {
  const matchedTokens = new Set();
  const tags = [];
  const details = [];
  let score = 0;

  // --- 1. –ë—Ä–µ–Ω–¥ (0 –∏–ª–∏ 30) ---
  const brand1 = extractBrand(text1);
  const brand2 = extractBrand(text2);
  const brandMatch = brand1 && brand2 && brand1 === brand2;
  if (brandMatch) {
    score += 30;
    tags.push('üè∑Ô∏è –ë—Ä–µ–Ω–¥');
    details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 30, matched: true });
    matchedTokens.add(brand1);
  } else {
    details.push({ component: 'üè∑Ô∏è –ë—Ä–µ–Ω–¥', score: 0, matched: false });
  }

  // --- 2. –í–µ—Å (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –∫ –≥—Ä–∞–º–º–∞–º) ---
  const w1 = extractWeight(text1);
  const w2 = extractWeight(text2);
  let weightPenalty = false;
  if (w1 && w2) {
    if (w1.unit === w2.unit && Math.abs(w1.value - w2.value) < 1) {
      score += 15; // V4.1: —Å–Ω–∏–∂–µ–Ω (–±—ã–ª 25)
      tags.push('‚öñÔ∏è –í–µ—Å=');
      details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 15, matched: true });
      matchedTokens.add(w1.value + w1.unit);
    } else {
      score -= 25; // V4.1: —Å–Ω–∏–∂–µ–Ω (–±—ã–ª -40)
      weightPenalty = true;
      tags.push('‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–µ—Å');
      details.push({ component: '‚öñÔ∏è –í–µ—Å', score: -25, matched: false, penalty: true });
    }
  } else {
    details.push({ component: '‚öñÔ∏è –í–µ—Å', score: 0, matched: false });
  }

  // --- 3. –í–∫—É—Å—ã ---
  const f1 = extractFlavors(text1);
  const f2 = extractFlavors(text2);
  const commonFlavors = [...f1].filter(f => f2.has(f));
  const missingFlavors = [...f1].filter(f => !f2.has(f)).concat([...f2].filter(f => !f1.has(f)));
  if (commonFlavors.length > 0 && missingFlavors.length === 0) {
    score += 15;
    tags.push('üçì –í–∫—É—Å=');
    details.push({ component: 'üçì –í–∫—É—Å', score: 15, matched: true });
    commonFlavors.forEach(f => matchedTokens.add(f));
  } else if (f1.size > 0 && f2.size > 0 && missingFlavors.length > 0) {
    score -= 10;
    tags.push('‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–∫—É—Å');
    details.push({ component: 'üçì –í–∫—É—Å', score: -10, matched: false, penalty: true });
  } else {
    details.push({ component: 'üçì –í–∫—É—Å', score: 0, matched: false });
  }

  // --- 4. –£–ø–∞–∫–æ–≤–∫–∞ ---
  const pkg1 = extractPackaging(text1);
  const pkg2 = extractPackaging(text2);
  if (pkg1 && pkg2) {
    if (pkg1 === pkg2) {
      score += 10;
      tags.push('üì¶ –£–ø–∞–∫=');
      details.push({ component: 'üì¶ –£–ø–∞–∫–æ–≤–∫–∞', score: 10, matched: true });
    } else {
      score -= 15;
      tags.push('‚ö†Ô∏è –†–∞–∑–Ω–∞—è —É–ø.');
      details.push({ component: 'üì¶ –£–ø–∞–∫–æ–≤–∫–∞', score: -15, matched: false, penalty: true });
    }
  }

  // --- 5. V4.0: –¢—Ä–∏–≥—Ä–∞–º–º—ã —Å TOKEN SET RATIO ---
  // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º –∏–∑: –ø—Ä—è–º–æ–≥–æ, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ, —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
  const n1_direct  = normalizeText(text1);
  const n2_direct  = normalizeText(text2);
  const n1_sorted  = normalizeText(text1, { sorted: true });
  const n2_sorted  = normalizeText(text2, { sorted: true });
  const n1_phsort  = normalizeText(text1, { sorted: true, phonetic: true });
  const n2_phsort  = normalizeText(text2, { sorted: true, phonetic: true });

  const triDirect = trigramSimilarity(n1_direct, n2_direct);
  const triSorted = trigramSimilarity(n1_sorted, n2_sorted);
  const triPhSorted = trigramSimilarity(n1_phsort, n2_phsort);
  const triSim = Math.max(triDirect, triSorted, triPhSorted);

  const triScore = Math.round(triSim * 30);
  if (triScore > 0) {
    score += triScore;
    const mode = triPhSorted > triSorted && triPhSorted > triDirect ? ' (—Ñ–æ–Ω.)' :
                 triSorted > triDirect ? ' (—Å–æ—Ä—Ç.)' : '';
    details.push({ component: `üìä –¢—Ä–∏–≥—Ä–∞–º–º—ã${mode}`, score: triScore, matched: triScore > 5 });
    if (triPhSorted > triSorted && triPhSorted > triDirect) tags.push('üî§ –§–æ–Ω–µ—Ç–∏–∫–∞');
    else if (triSorted > triDirect) tags.push('üîÄ Token Set');
  }

  // --- 6. –¢–æ–∫–µ–Ω—ã (–±–µ–∑ —Å—Ç–æ–ø-—Å–ª–æ–≤) ---
  const tokens1 = getSignificantTokens(text1);
  const tokens2 = getSignificantTokens(text2);
  const tset2 = new Set(tokens2);
  const exactCommon = tokens1.filter(w => tset2.has(w) && w.length > 2);
  if (exactCommon.length > 0) {
    const tokScore = Math.min(15, exactCommon.length * 4);
    score += tokScore;
    details.push({ component: 'üìù –°–ª–æ–≤–∞', score: tokScore, matched: true });
    exactCommon.forEach(w => matchedTokens.add(w));
  }

  // --- 7. –ö—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤–æ–µ + Jaro-Winkler ---
  let crossScore = 0;
  for (const t1 of tokens1) {
    for (const t2 of tokens2) {
      if (t1 === t2 || t1.length < 3 || t2.length < 3) continue;
      const sim = crossLangSimilarity(t1, t2);
      if (sim > 0.85) {
        const bonus = Math.round((sim - 0.85) * 80);
        crossScore = Math.max(crossScore, bonus);
        matchedTokens.add(t2);
        matchedTokens.add(t1);
      }
    }
  }
  if (crossScore > 0) {
    score += crossScore;
    details.push({ component: 'üåê –ö—Ä–æ—Å—Å-—è–∑—ã–∫', score: crossScore, matched: true });
  }

  // --- 8. –ß–∏—Å–ª–∞ (–∫—Ä–æ–º–µ –≤–µ—Å–∞) ---
  const nums1 = extractNumbers(text1).filter(n => n !== (w1 ? w1.value : null) && n > 0);
  const nums2 = extractNumbers(text2).filter(n => n !== (w2 ? w2.value : null) && n > 0);
  const commonNums = nums1.filter(n => nums2.includes(n));
  if (commonNums.length > 0) {
    score += 8;
    details.push({ component: 'üî¢ –ß–∏—Å–ª–∞', score: 8, matched: true });
  }

  const maxPossible = 108; // 30+15+15+10+30+15+12+8‚àímax penalties
  const finalPercent = Math.max(0, Math.min(100, Math.round(score / maxPossible * 100)));

  return { score: finalPercent, rawScore: score, details, tags, matchedTokens, weightPenalty, weights: { w1, w2 } };
}

// =============================================================================
// –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í
// =============================================================================
document.getElementById('jsonInput').addEventListener('change', handleBaseUpload);
document.getElementById('priceInput').addEventListener('change', handlePriceUpload);

async function handleBaseUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã —Å–∏–Ω–æ–Ω–∏–º–æ–≤...');
    const fileName = file.name.toLowerCase();
    if (fileName.endsWith('.json')) {
      jsonData = JSON.parse(await file.text());
    } else if (fileName.endsWith('.csv')) {
      jsonData = convertTableToJSON(await parseCSV(file));
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
      jsonData = convertTableToJSON(await parseExcel(file));
    } else {
      throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
    }
    document.getElementById('jsonBox').classList.add('loaded');
    document.getElementById('jsonStatus').textContent = `‚úì ${Object.keys(jsonData).length} –∑–∞–ø–∏—Å–µ–π`;
    hideProgress();
    checkAndAnalyze();
  } catch (error) {
    hideProgress();
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã: ' + error.message);
  }
}

function convertTableToJSON(data) {
  const result = {};
  if (!data || data.length === 0) throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
  const barcodeCol = findColumn(data, BARCODE_COLS);
  const nameCol = findColumn(data, NAME_COLS);
  const synonymCol = findColumn(data, SYNONYM_COLS);
  if (!barcodeCol || !nameCol) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –®—Ç—Ä–∏—Ö–∫–æ–¥ –∏ –ù–∞–∑–≤–∞–Ω–∏–µ');
  for (const row of data) {
    const barcode = String(row[barcodeCol] || '').trim();
    const name = String(row[nameCol] || '').trim();
    const synonyms = synonymCol ? String(row[synonymCol] || '').trim() : '';
    if (barcode && name) result[barcode] = [name, synonyms];
  }
  return result;
}

async function handlePriceUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...');
    if (file.name.toLowerCase().endsWith('.csv')) {
      priceData = await parseCSV(file);
    } else {
      priceData = await parseExcel(file);
    }
    document.getElementById('priceBox').classList.add('loaded');
    document.getElementById('priceStatus').textContent = `‚úì ${priceData.length} —Ç–æ–≤–∞—Ä–æ–≤`;
    hideProgress();
    checkAndAnalyze();
  } catch (error) {
    hideProgress();
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: ' + error.message);
  }
}

function parseCSV(file) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true, skipEmptyLines: true,
      complete: (results) => resolve(results.data),
      error: (error) => reject(error)
    });
  });
}

function parseExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        resolve(XLSX.utils.sheet_to_json(sheet));
      } catch (error) { reject(error); }
    };
    reader.readAsArrayBuffer(file);
  });
}

function checkAndAnalyze() {
  if (Object.keys(jsonData).length > 0 && priceData.length > 0) {
    performEnhancedMatching();
  }
}

function findColumn(data, synonyms) {
  if (!data || data.length === 0) return null;
  const columns = Object.keys(data[0]);
  return columns.find(col => synonyms.some(syn => col.toLowerCase().includes(syn.toLowerCase()))) || columns[0];
}

// =============================================================================
// –ú–ê–¢–ß–ò–ù–ì
// =============================================================================
async function performEnhancedMatching() {
  showProgress('Smart Matcher V4.1 ‚Äî —É–ø–∞–∫–æ–≤–∫–∞ + —Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥–∏ + –æ–ø–µ—á–∞—Ç–∫–∏...');
  matchResults = []; skippedItems = []; highMatches = []; reviewItems = []; allMatches = [];

  const barcodeCol = findColumn(priceData, BARCODE_COLS);
  const nameCol = findColumn(priceData, NAME_COLS);

  if (!barcodeCol || !nameCol) {
    hideProgress();
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã "–®—Ç—Ä–∏—Ö–∫–æ–¥" –∏ "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" –≤ –ø—Ä–∞–π—Å–µ');
    return;
  }

  const jsonMap = new Map();
  // V4.1: Map<barcode, {type,jsonKey,mainBarcode,name}> –¥–ª—è –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞
  const allBarcodes = new Map();

  for (const [key, value] of Object.entries(jsonData)) {
    const keyIsBarcode = isBarcode(key);
    let name = key;
    let mainBarcode = keyIsBarcode ? key : '';
    let synonyms = [];

    if (Array.isArray(value)) {
      if (value.length > 0 && value[0]) name = String(value[0]).trim();
      if (value.length > 2) {
        synonyms = value.slice(1).map(s => String(s).trim()).filter(s => s && isBarcode(s));
      } else if (value.length === 2 && value[1]) {
        const synonymsStr = String(value[1]).trim();
        if (synonymsStr) synonyms = synonymsStr.split(';').map(s => s.trim()).filter(s => s && isBarcode(s));
      }
    }

    jsonMap.set(key, { hasMainBarcode: keyIsBarcode, mainBarcode, name, synonyms });
    if (keyIsBarcode) allBarcodes.set(key, { type: 'main', jsonKey: key, name });
    synonyms.forEach(syn => allBarcodes.set(syn, { type: 'synonym', jsonKey: key, mainBarcode, name }));
  }

  for (let i = 0; i < priceData.length; i++) {
    const row = priceData[i];
    const barcode = String(row[barcodeCol] || '').trim();
    const name = String(row[nameCol] || '').trim();
    if (!barcode || !name) continue;

    const candidates = [];
    for (const [key, data] of jsonMap) {
      const result = calculateSimilarity(name, data.name);
      if (result.score >= SIMILARITY_THRESHOLD) {
        candidates.push({ key, ...data, similarity: result.score, matchResult: result });
      }
    }

    candidates.sort((a, b) => b.similarity - a.similarity);
    const top3 = candidates.slice(0, 3);
    const bestMatch = top3[0];

    if (bestMatch) {
      const dupInfo = allBarcodes.get(barcode);
      const isDuplicate = !!dupInfo;
      const sim = bestMatch.similarity;

      if (isDuplicate) {
        const skipReason = dupInfo.type === 'main'
          ? '–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥'
          : '–°–∏–Ω–æ–Ω–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–∞';
        const skipDetail = dupInfo.type === 'main'
          ? `–®–ö ${barcode} ‚Äî –≥–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ "${dupInfo.name}"`
          : `–®–ö ${barcode} ‚Äî —Å–∏–Ω–æ–Ω–∏–º —Ç–æ–≤–∞—Ä–∞ "${dupInfo.name}" (–≥–ª–∞–≤–Ω—ã–π –®–ö: ${dupInfo.mainBarcode || dupInfo.jsonKey})`;
        skippedItems.push({ barcode, name, reason: 'duplicate', skipReason, skipDetail,
          matchName: bestMatch.name, mainBarcode: bestMatch.mainBarcode, similarity: sim,
          matchResult: bestMatch.matchResult, candidates: top3 });
      } else {
        const matchData = {
          barcode, name,
          mainBarcode: bestMatch.mainBarcode, mainName: bestMatch.name,
          synonyms: bestMatch.synonyms, hasMainBarcode: bestMatch.hasMainBarcode,
          jsonKey: bestMatch.key, similarity: sim,
          matchResult: bestMatch.matchResult, candidates: top3,
          weightPenalty: bestMatch.matchResult.weightPenalty
        };
        if (sim >= REVIEW_THRESHOLD) {
          matchResults.push(matchData);
          if (sim >= HIGH_THRESHOLD) highMatches.push(matchData);
        } else {
          reviewItems.push(matchData);
        }
      }
      allMatches.push({ barcode, name, status: isDuplicate ? 'skipped' : 'new', similarity: sim, matchResult: bestMatch.matchResult });
    }

    if (i % 10 === 0) {
      updateProgress((i / priceData.length) * 100);
      await new Promise(resolve => setTimeout(resolve, 0));
    }
  }

  matchResults.sort((a, b) => b.similarity - a.similarity);
  reviewItems.sort((a, b) => b.similarity - a.similarity);

  document.getElementById('statTotal').textContent = priceData.length;
  document.getElementById('statNew').textContent = matchResults.length;
  document.getElementById('statHigh').textContent = highMatches.length;
  document.getElementById('statReview').textContent = reviewItems.length;
  document.getElementById('statSkipped').textContent = skippedItems.length;
  document.getElementById('statsBar').classList.add('show');
  document.getElementById('resultsPanel').classList.add('show');

  hideProgress();
  filterByView('high');
}

// =============================================================================
// –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –†–ï–ù–î–ï–†
// =============================================================================
function filterByView(view) {
  currentView = view;
  document.querySelectorAll('.stat-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.view === view) item.classList.add('active');
  });

  if (view === 'high') {
    document.getElementById('resultsTitle').textContent = '‚≠ê –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (‚â•80%)';
    document.getElementById('resultsSubtitle').textContent = `${highMatches.length} —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å–∏–Ω–æ–Ω–∏–º—ã`;
    renderResults(highMatches, 'match');
  } else if (view === 'new') {
    const mid = matchResults.filter(r => r.similarity < HIGH_THRESHOLD);
    document.getElementById('resultsTitle').textContent = 'üìä –ù–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã (60‚Äì79%)';
    document.getElementById('resultsSubtitle').textContent = `${mid.length} —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ö–æ—Ä–æ—à–∏–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º`;
    renderResults(mid, 'match');
  } else if (view === 'review') {
    document.getElementById('resultsTitle').textContent = 'üîç –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ (42‚Äì59%) ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å–∞–º–∏';
    document.getElementById('resultsSubtitle').textContent = `${reviewItems.length} —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –≤—ã —Ä–µ—à–∞–µ—Ç–µ`;
    renderResults(reviewItems, 'review');
  } else if (view === 'skipped') {
    document.getElementById('resultsTitle').textContent = '‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ (–¥—É–±–ª–∏)';
    document.getElementById('resultsSubtitle').textContent = `${skippedItems.length} —Ç–æ–≤–∞—Ä–æ–≤ —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ`;
    renderResults(skippedItems, 'skipped');
  } else {
    document.getElementById('resultsTitle').textContent = 'üìã –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è';
    document.getElementById('resultsSubtitle').textContent = `${allMatches.length} —Ç–æ–≤–∞—Ä–æ–≤`;
    renderResults(allMatches, 'all');
  }
}

function highlightMatches(text, matchedTokens) {
  if (!matchedTokens || matchedTokens.size === 0) return text;
  let result = text;
  for (const token of matchedTokens) {
    try {
      const regex = new RegExp(`(${token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      result = result.replace(regex, '<span class="highlight">$1</span>');
    } catch(e) {}
  }
  return result;
}

function renderResults(items, type) {
  const container = document.getElementById('resultsList');

  if (items.length === 0) {
    const emptyMessages = {
      'match': '–ù–æ–≤—ã—Ö —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
      'skipped': '–ù–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤',
      'high': '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ö–æ–∂–µ—Å—Ç—å—é',
    };
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚úì</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${emptyMessages[type] || '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}</div>
      </div>`;
    return;
  }

  let html = '';

  items.forEach((result, index) => {
    const sim = result.similarity || 0;
    const mr = result.matchResult || {};
    let cardClass, simClass, actionLabel, actionClass;

    if (type === 'skipped') {
      cardClass = 'skipped-card'; simClass = 'skip'; actionLabel = '‚è≠Ô∏è –î—É–±–ª—å'; actionClass = 'action-skip';
    } else if (type === 'review') {
      cardClass = 'review-card'; simClass = 'review'; actionLabel = 'üîç –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'; actionClass = 'action-review';
    } else {
      cardClass = sim >= 80 ? 'high-match' : 'medium-match';
      simClass = sim >= 80 ? 'high' : 'medium';
      actionLabel = result.hasMainBarcode ? '‚ûï –°–∏–Ω–æ–Ω–∏–º' : '‚≠ê –ì–ª–∞–≤–Ω—ã–π';
      actionClass = result.hasMainBarcode ? 'action-synonym' : 'action-main';
    }

    const matchTags = (mr.tags || []).map(t => `<span class="match-tag">${t}</span>`).join('');
    const mainName = type === 'skipped' ? (result.matchName || '') : (result.mainName || '');
    const highlightedPriceName = highlightMatches(result.name, mr.matchedTokens);
    const highlightedJsonName = highlightMatches(mainName, mr.matchedTokens);

    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    const normA = normalizeText(result.name, { sorted: true });
    const normB = normalizeText(mainName, { sorted: true });

    let scoreDetails = '';
    if (mr.details) {
      scoreDetails = mr.details.filter(d => d.score !== 0).map(d =>
        `<span class="score-item" style="${d.penalty ? 'background:#fff0f0' : ''}">
          <span class="score-icon">${d.component.split(' ')[0]}</span>
          <span style="color:${d.penalty ? '#ff3b30' : '#34c759'}">${d.score > 0 ? '+' : ''}${d.score}</span>
        </span>`
      ).join('');
    }

    const weightWarn = (result.weightPenalty || mr.weightPenalty) ?
      `<div class="weight-warning">‚ö†Ô∏è –†–∞–∑–Ω—ã–π –≤–µ—Å ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–∞–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã!</div>` : '';

    let candidatesHtml = '';
    if (result.candidates && result.candidates.length > 1) {
      const cands = result.candidates.slice(0, 3).map((c, ci) => {
        const cSim = c.similarity;
        const cColor = cSim >= 80 ? '#34c759' : cSim >= 60 ? '#ff9500' : '#af52de';
        const isMain = ci === 0;
        return `
          <div class="candidate-item ${isMain ? 'selected' : ''}"
               onclick="selectCandidate(event, ${index}, ${ci}, '${type}')">
            <span class="candidate-score" style="background:${cColor}">${cSim}%</span>
            <span class="candidate-name">${c.name}</span>
            <span class="candidate-bc">${c.mainBarcode || c.key || ''}</span>
            ${type !== 'skipped' ? `<button class="select-candidate-btn" onclick="selectAndConfirm(event,${index},${ci},'${type}')">–í—ã–±—Ä–∞—Ç—å</button>` : ''}
          </div>`;
      }).join('');
      candidatesHtml = `
        <div class="candidates-section">
          <div class="candidates-title">üîé –ö–∞–Ω–¥–∏–¥–∞—Ç—ã (${result.candidates.length} –Ω–∞–π–¥–µ–Ω–æ)</div>
          ${cands}
        </div>`;
    }

    const clickable = type !== 'skipped' ? `onclick="showConfirmModal(${index}, '${type}')"` : '';

    html += `
      <div class="result-card ${cardClass}" ${clickable}>
        <div class="card-header">
          <div class="card-left">
            <span class="similarity-badge similarity-${simClass}">${sim}%</span>
            <div class="match-tags">${matchTags}</div>
          </div>
          <span class="action-badge ${actionClass}">${actionLabel}</span>
        </div>
        ${type === 'skipped' && result.skipReason ? `
          <div class="skip-reason-box ${result.skipReason === '–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥' ? 'is-main' : 'is-synonym'}">
            <span>${result.skipReason === '–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥' ? 'üîë –ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥' : 'üîó –°–∏–Ω–æ–Ω–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–∞'}</span>
            <span class="skip-reason-detail">${result.skipDetail || ''}</span>
          </div>` : ''}
        <div class="comparison-vertical">
          <div class="name-box price-box">
            <div class="name-label"><span>üìÑ</span><span>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</span></div>
            <div class="name-text">${highlightedPriceName}</div>
            <div class="barcode-info">–®–ö: ${result.barcode}</div>
            <div class="name-norm">‚Üí ${normA}</div>
          </div>
          <div class="name-box json-box">
            <div class="name-label"><span>üì¶</span><span>–í –±–∞–∑–µ (–ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)</span></div>
            <div class="name-text">${highlightedJsonName}</div>
            <div class="barcode-info">–®–ö: ${result.mainBarcode || result.hasMainBarcode ? (result.mainBarcode || result.key) : '[–ù–µ—Ç –®–ö]'}</div>
            <div class="name-norm">‚Üí ${normB}</div>
          </div>
        </div>
        ${weightWarn}
        ${scoreDetails ? `<div class="score-details">${scoreDetails}</div>` : ''}
        ${candidatesHtml}
      </div>`;
  });

  container.innerHTML = html;
}

// =============================================================================
// –í–´–ë–û–† –ö–ê–ù–î–ò–î–ê–¢–ê
// =============================================================================
function selectCandidate(e, itemIndex, candidateIndex, type) {
  e.stopPropagation();
  const list = type === 'high' ? highMatches :
               type === 'new' ? matchResults.filter(r => r.similarity < HIGH_THRESHOLD) :
               type === 'review' ? reviewItems : skippedItems;
  if (!list[itemIndex] || !list[itemIndex].candidates) return;
  const cands = list[itemIndex].candidates;
  const chosen = cands.splice(candidateIndex, 1)[0];
  cands.unshift(chosen);
  list[itemIndex].mainBarcode = chosen.mainBarcode;
  list[itemIndex].mainName = chosen.name;
  list[itemIndex].hasMainBarcode = chosen.hasMainBarcode;
  list[itemIndex].jsonKey = chosen.key;
  list[itemIndex].similarity = chosen.similarity;
  list[itemIndex].matchResult = chosen.matchResult;
  list[itemIndex].weightPenalty = chosen.matchResult.weightPenalty;
  filterByView(currentView);
}

function selectAndConfirm(e, itemIndex, candidateIndex, type) {
  e.stopPropagation();
  selectCandidate(e, itemIndex, candidateIndex, type);
  showConfirmModal(itemIndex, type);
}

// =============================================================================
// –ú–û–î–ê–õ–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
// =============================================================================
function showConfirmModal(index, type) {
  let list;
  if (type === 'high') list = highMatches;
  else if (type === 'review') list = reviewItems;
  else list = matchResults.filter(r => r.similarity < HIGH_THRESHOLD);

  const result = list[index];
  if (!result) return;
  pendingAction = result;

  document.getElementById('modalSimilarity').textContent = result.similarity + '%';
  document.getElementById('modalPriceBarcode').textContent = result.barcode;
  document.getElementById('modalPriceName').textContent = result.name.toUpperCase();

  const modalMainBarcode = document.getElementById('modalMainBarcode');
  modalMainBarcode.textContent = result.hasMainBarcode ? result.mainBarcode : '[–ù–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö]';
  document.getElementById('modalMainName').textContent = result.mainName.toUpperCase();

  const actionInfoCompact = document.getElementById('actionInfoCompact');
  const confirmBtn = document.getElementById('confirmBtn');

  if (result.hasMainBarcode) {
    actionInfoCompact.className = 'action-info-compact';
    document.getElementById('actionTextCompact').textContent = '‚ûï –®—Ç—Ä–∏—Ö–∫–æ–¥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ —Å–∏–Ω–æ–Ω–∏–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–æ–≤–∞—Ä—É';
    confirmBtn.textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º';
  } else {
    actionInfoCompact.className = 'action-info-compact main';
    document.getElementById('actionTextCompact').textContent = '‚≠ê –®—Ç—Ä–∏—Ö–∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç –ì–õ–ê–í–ù–´–ú –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—É —Ç–æ–≤–∞—Ä–∞ —Å–µ–π—á–∞—Å –Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –®–ö)';
    confirmBtn.textContent = '‚≠ê –°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º';
  }

  document.getElementById('confirmModal').classList.add('show');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('show');
  pendingAction = null;
}

function confirmAction() {
  if (!pendingAction) return;
  const action = pendingAction.hasMainBarcode ? 'add_synonym' : 'set_main';
  changesMap.set(pendingAction.barcode, {
    action, mainBarcode: pendingAction.mainBarcode || '',
    jsonKey: pendingAction.jsonKey || '',
    newBarcode: pendingAction.barcode, newName: pendingAction.name,
    mainName: pendingAction.mainName, similarity: pendingAction.similarity
  });

  const bc = pendingAction.barcode;
  matchResults = matchResults.filter(r => r.barcode !== bc);
  highMatches = highMatches.filter(r => r.barcode !== bc);
  reviewItems = reviewItems.filter(r => r.barcode !== bc);

  document.getElementById('statNew').textContent = matchResults.length;
  document.getElementById('statHigh').textContent = highMatches.length;
  document.getElementById('statReview').textContent = reviewItems.length;
  document.getElementById('exportTopCount').textContent = changesMap.size;
  document.getElementById('exportTopBtn').classList.add('show');

  closeModal();
  filterByView(currentView);
}

// =============================================================================
// –≠–ö–°–ü–û–†–¢ JSON
// =============================================================================
async function exportJSON() {
  const updated = JSON.parse(JSON.stringify(jsonData));

  changesMap.forEach((change, barcode) => {
    if (change.action === 'add_synonym') {
      const lookupKey = change.jsonKey || change.mainBarcode;
      const currentData = updated[lookupKey];
      if (Array.isArray(currentData) && currentData.length >= 1) {
        const name = currentData[0];
        let synonyms = [];
        if (currentData.length > 2) {
          synonyms = currentData.slice(1).map(s => String(s).trim()).filter(Boolean);
        } else if (currentData.length === 2 && currentData[1]) {
          synonyms = String(currentData[1]).trim().split(';').map(s => s.trim()).filter(Boolean);
        }
        if (barcode && !synonyms.includes(barcode)) synonyms.push(barcode);
        updated[lookupKey] = [name, ...synonyms];
      }
    } else if (change.action === 'set_main') {
      updated[barcode] = [change.mainName];
      if (updated[change.jsonKey]) delete updated[change.jsonKey];
    }
  });

  const json = JSON.stringify(updated, null, 2);
  const timestamp = new Date().toISOString().slice(0, 10);
  const fileName = `synonyms_v41_${timestamp}.json`;

  if (window.showSaveFilePicker) {
    try {
      const fileHandle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: 'JSON —Ñ–∞–π–ª', accept: { 'application/json': ['.json'] } }]
      });
      const writable = await fileHandle.createWritable();
      await writable.write(json);
      await writable.close();
      alert(`‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${changesMap.size} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n–§–∞–π–ª: ${fileHandle.name}`);
      return;
    } catch (err) {
      if (err.name === 'AbortError') return;
    }
  }

  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fileName;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert(`‚úÖ JSON –æ–±–Ω–æ–≤–ª—ë–Ω!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${changesMap.size} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n–§–∞–π–ª: ${fileName}`);
}

function isBarcode(str) { return /^\d{8,14}$/.test(String(str).trim()); }
function showProgress(text) {
  document.getElementById('progressBar').classList.add('show');
  document.getElementById('progressText').textContent = text;
  document.getElementById('progressFill').style.width = '0%';
}
function updateProgress(percent) { document.getElementById('progressFill').style.width = percent + '%'; }
function hideProgress() { document.getElementById('progressBar').classList.remove('show'); }

document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>

<script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>

</body>
</html>
